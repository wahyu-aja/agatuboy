<!DOCTYPE html><html lang="id">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Scanner Barcode â€¢ Simpan & Tampilkan</title>
  <style>
    /* (style sama dengan versi sebelumnya) */
  </style>
</head>
<body>
  <header>
    <h1>ðŸ“· Scanner Barcode â€¢ Simpan âžœ Tampilkan (PLU, Nama, Gambar)</h1>
  </header>  <div class="wrap">
    <div class="grid">
      <!-- SCANNER CARD -->
      <section class="card" id="scanner-card">
        <div class="body">
          <h2>1) Pindai Barcode</h2>
          <div class="row" style="margin-bottom:8px">
            <button id="btnStart">Mulai Scan</button>
            <button id="btnStop" class="secondary" disabled>Hentikan</button>
            <button id="btnSave" class="ok" disabled>Simpan Hasil</button>
            <button id="btnCancel" class="danger">Batal</button>
          </div>
          <div class="hint">Gunakan kamera belakang (jika ada). Sistem akan menambahkan hasil unik satu per satu sesuai urutan scan.</div>
          <video id="preview" playsinline muted></video>
          <div class="list" id="scanList"></div>
          <div class="hint">Total discan: <span id="scanCount">0</span> â€¢ Perangkat: <span id="camLabel">-</span></div>
        </div>
      </section><!-- VIEWER CARD -->
  <section class="card" id="viewer-card">
    <div class="body">
      <h2>2) Tampilkan Hasil</h2>
      <div class="row" style="margin-bottom:8px">
        <button id="btnShow" class="ghost" disabled>Tampilkan Barcode</button>
      </div>

      <div id="viewer" class="viewer">
        <div class="empty" id="emptyViewer">Belum ada hasil tersimpan. Pindai dulu, lalu klik <b>Simpan Hasil</b>.</div>

        <div id="itemViewer" style="display:none">
          <div class="title">PLU: <span id="plu" class="mono"></span></div>
          <div>Nama Produk: <span id="name"></span></div>
          <div style="display:flex;align-items:center;gap:16px;flex-wrap:wrap;margin-top:8px">
            <div>
              <svg id="barcodeSvg"></svg>
              <div class="hint">Kode Asli: <span id="raw" class="mono"></span></div>
            </div>
            <img id="prodImg" class="prod" alt="Gambar produk" />
          </div>
          <div class="nav">
            <button id="prevBtn" class="secondary">âŸµ Sebelumnya</button>
            <div class="badge">Index: <span id="idxNow">0</span>/<span id="idxTotal">0</span></div>
            <button id="nextBtn">Berikutnya âŸ¶</button>
          </div>
        </div>
      </div>
    </div>
  </section>
</div>

<footer>
  <div>File <span class="mono">bcd.json</span> harus diletakkan di folder yang sama dengan file ini (<span class="mono">index.html</span>), agar nama & PLU bisa dicocokkan.</div>
</footer>

  </div>  <!-- ZXing untuk scanning -->  <script src="https://cdn.jsdelivr.net/npm/@zxing/library@0.20.0"></script>  <!-- JsBarcode untuk render gambar barcode -->  <script src="https://cdn.jsdelivr.net/npm/jsbarcode@3.11.6/dist/JsBarcode.all.min.js"></script>  <dialog id="confirmCancel">
    <div class="mwrap">
      <h3 style="margin:0 0 8px 0">Batalkan & hapus hasil sementara?</h3>
      <div class="hint">Semua hasil yang belum disimpan akan hilang.</div>
    </div>
    <div class="actions">
      <button id="cancelNo" class="secondary">Tidak</button>
      <button id="cancelYes" class="danger">Ya, Hapus</button>
    </div>
  </dialog>  <script>
    const scanned = [];
    let saved = [];
    let currentIndex = 0;

    const videoEl = document.getElementById('preview');
    const btnStart = document.getElementById('btnStart');
    const btnStop  = document.getElementById('btnStop');
    const btnSave  = document.getElementById('btnSave');
    const btnCancel= document.getElementById('btnCancel');
    const scanList = document.getElementById('scanList');
    const scanCount= document.getElementById('scanCount');
    const camLabel = document.getElementById('camLabel');

    const btnShow  = document.getElementById('btnShow');
    const emptyViewer = document.getElementById('emptyViewer');
    const itemViewer  = document.getElementById('itemViewer');

    const spanPLU = document.getElementById('plu');
    const spanName= document.getElementById('name');
    const spanRaw = document.getElementById('raw');
    const svgBarcode = document.getElementById('barcodeSvg');
    const imgProd  = document.getElementById('prodImg');
    const idxNow = document.getElementById('idxNow');
    const idxTotal = document.getElementById('idxTotal');
    const prevBtn = document.getElementById('prevBtn');
    const nextBtn = document.getElementById('nextBtn');

    const dlgCancel = document.getElementById('confirmCancel');
    const cancelNo = document.getElementById('cancelNo');
    const cancelYes = document.getElementById('cancelYes');

    let products = [];
    let mapByBarcode = new Map();

    async function loadProducts() {
      try {
        const res = await fetch('bcd.json', { cache: 'no-store' });
        if (!res.ok) throw new Error('Gagal membaca bcd.json');
        products = await res.json();
        products.forEach(p=>{
          if (p.BARCODE) mapByBarcode.set(String(p.BARCODE), p);
        });
      } catch (e) {
        console.warn('bcd.json tidak ditemukan atau rusak:', e);
        products = [];
      }
    }
    loadProducts();

    const { BrowserMultiFormatReader, NotFoundException } = ZXing;
    let codeReader = null;
    let currentDeviceId = null;
    let scanActive = false;
    let lastText = '';
    let throttle = false;

    async function startScan(){
      if (scanActive) return;
      btnStart.disabled = true;
      btnStop.disabled = false;
      btnSave.disabled = false;

      if (!codeReader) codeReader = new BrowserMultiFormatReader();
      const devices = await BrowserMultiFormatReader.listVideoInputDevices();
      let deviceId = devices?.[0]?.deviceId || null;
      const back = devices.find(d=>/back|rear|belakang/i.test(d.label));
      if (back) deviceId = back.deviceId;
      currentDeviceId = deviceId;
      camLabel.textContent = (devices.find(d=>d.deviceId===deviceId)?.label) || 'Kamera';

      scanActive = true;
      lastText = '';

      await codeReader.decodeFromVideoDevice(deviceId, videoEl, (result, err)=>{
        if (!scanActive) return;
        if (result) {
          const text = String(result.getText());
          if (throttle || text === lastText) return;
          throttle = true; setTimeout(()=>{ throttle = false; }, 350);
          lastText = text;
          onScan(text);
        } else if (err && !(err instanceof NotFoundException)) {
          console.error(err);
        }
      });
    }

    async function stopScan(){
      scanActive = false;
      try { codeReader?.reset(); } catch(e){}
      btnStart.disabled = false;
      btnStop.disabled = true;
    }

    function onScan(code){
      if (!code) return;
      if (!scanned.includes(code)) {
        scanned.push(code);
        renderScanList();
      }
    }

    function renderScanList(){
      scanList.innerHTML = '';
      scanned.forEach((code, i)=>{
        const div = document.createElement('span');
        div.className = 'pill mono';
        div.textContent = `${i+1}. ${code}`;
        scanList.appendChild(div);
      });
      scanCount.textContent = scanned.length;
      btnSave.disabled = scanned.length === 0;
    }

    function saveResults(){
      saved = scanned.slice();
      currentIndex = 0;
      btnShow.disabled = saved.length === 0;
      if (saved.length > 0) showViewer();
    }

    function openCancelDialog(){
      dlgCancel.showModal();
    }
    function performCancel(){
      stopScan();
      scanned.splice(0, scanned.length);
      renderScanList();
      btnSave.disabled = true;
      btnShow.disabled = saved.length === 0;
      dlgCancel.close();
    }

    function showViewer(){
      emptyViewer.style.display = 'none';
      itemViewer.style.display = '';
      idxTotal.textContent = saved.length;
      renderViewer(currentIndex);
    }

    function guessFormat(code){
      if (/^\d{13}$/.test(code)) return 'EAN13';
      if (/^\d{8}$/.test(code)) return 'EAN8';
      return 'CODE128';
    }

    function lookupProduct(code){
      if (mapByBarcode.has(code)) return mapByBarcode.get(code);
      return { PLU: '', NAMA_PRODUK: '(Produk tidak ditemukan di bcd.json)', BARCODE: code };
    }

    function renderViewer(i){
      if (saved.length === 0) return;
      if (i<0) i=0; if (i>saved.length-1) i=saved.length-1; currentIndex = i;

      const code = saved[i];
      const info = lookupProduct(code);

      const plu = info.PLU || '';
      const name = info.NAMA_PRODUK || '(Nama tidak tersedia)';

      spanPLU.textContent = plu;
      spanName.textContent = name;
      spanRaw.textContent = code;

      svgBarcode.innerHTML = '';
      try {
        JsBarcode(svgBarcode, code, { format: guessFormat(code), displayValue: true, fontSize: 16, margin: 8, height: 90 });
      } catch(e){
        JsBarcode(svgBarcode, code, { format: 'CODE128', displayValue: true, fontSize: 16, margin: 8, height: 90 });
      }

      if (plu) {
        const imageUrl = `https://cdn-klik.klikindomaret.com/klik-catalog/product/${plu}_1.jpg`;
        imgProd.src = imageUrl;
        imgProd.style.display = '';
      } else {
        imgProd.removeAttribute('src');
        imgProd.style.display = 'none';
      }

      idxNow.textContent = i+1;
      idxTotal.textContent = saved.length;

      prevBtn.disabled = (i===0);
      nextBtn.disabled = (i===saved.length-1);
    }

    btnStart.addEventListener('click', startScan);
    btnStop.addEventListener('click', stopScan);
    btnSave.addEventListener('click', ()=>{ saveResults(); btnShow.disabled=false; });
    btnCancel.addEventListener('click', openCancelDialog);

    btnShow.addEventListener('click', ()=>{ if(saved.length>0){ showViewer(); } });
    prevBtn.addEventListener('click', ()=> renderViewer(currentIndex-1));
    nextBtn.addEventListener('click', ()=> renderViewer(currentIndex+1));

    cancelNo.addEventListener('click', ()=> dlgCancel.close());
    cancelYes.addEventListener('click', performCancel);

    window.addEventListener('pagehide', stopScan);
  </script></body>
</html>
