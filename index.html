<!DOCTYPE html><html lang="id">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Scanner Barcode â€¢ Simpan & Tampilkan</title>
  <style>
    /* (style sama dengan versi sebelumnya) */
  </style>
</head>
<body>
  <header>
    <h1>ðŸ“· Scanner Barcode â€¢ Simpan âžœ Tampilkan (PLU, Nama, Gambar)</h1>
  </header>  <div class="wrap">
    <div class="grid">
      <!-- SCANNER CARD -->
      <section class="card" id="scanner-card">
        <div class="body">
          <h2>1) Pindai Barcode</h2>
          <div class="row" style="margin-bottom:8px">
            <button id="btnStart">Mulai Scan</button>
            <button id="btnStop" class="secondary" disabled>Hentikan</button>
            <button id="btnSave" class="ok" disabled>Simpan Hasil</button>
            <button id="btnCancel" class="danger">Batal</button>
          </div>
          <div class="hint">Gunakan kamera belakang (jika ada). Sistem akan menambahkan hasil unik satu per satu sesuai urutan scan.</div>
          <video id="preview" playsinline muted></video>
          <div class="list" id="scanList"></div>
          <div class="hint">Total discan: <span id="scanCount">0</span> â€¢ Perangkat: <span id="camLabel">-</span></div>
        </div>
      </section><!-- VIEWER CARD -->
  <section class="card" id="viewer-card">
    <div class="body">
      <h2>2) Tampilkan Hasil</h2>
      <div class="row" style="margin-bottom:8px">
        <button id="btnShow" class="ghost" disabled>Tampilkan Barcode</button>
      </div>

      <div id="viewer" class="viewer">
        <div class="empty" id="emptyViewer">Belum ada hasil tersimpan. Pindai dulu, lalu klik <b>Simpan Hasil</b>.</div>

        <div id="itemViewer" style="display:none">
          <div class="title">PLU: <span id="plu" class="mono"></span></div>
          <div>Nama Produk: <span id="name"></span></div>
          <div style="display:flex;align-items:center;gap:16px;flex-wrap:wrap;margin-top:8px">
            <div>
              <svg id="barcodeSvg"></svg>
              <div class="hint">Kode Asli: <span id="raw" class="mono"></span></div>
            </div>
            <img id="prodImg" class="prod" alt="Gambar produk" />
          </div>
          <div class="nav">
            <button id="prevBtn" class="secondary">âŸµ Sebelumnya</button>
            <div class="badge">Index: <span id="idxNow">0</span>/<span id="idxTotal">0</span></div>
            <button id="nextBtn">Berikutnya âŸ¶</button>
          </div>
        </div>
      </div>
    </div>
  </section>
</div>

<footer>
  <div>File <span class="mono">bcd.json</span> harus diletakkan di folder yang sama dengan file ini (<span class="mono">index.html</span>), agar nama & PLU bisa dicocokkan.</div>
</footer>

  </div>  <!-- ZXing untuk scanning -->  <script src="https://cdn.jsdelivr.net/npm/@zxing/library@0.20.0"></script>  <!-- JsBarcode untuk render gambar barcode -->  <script src="https://cdn.jsdelivr.net/npm/jsbarcode@3.11.6/dist/JsBarcode.all.min.js"></script>  <dialog id="confirmCancel">
    <div class="mwrap">
      <h3 style="margin:0 0 8px 0">Batalkan & hapus hasil sementara?</h3>
      <div class="hint">Semua hasil yang belum disimpan akan hilang.</div>
    </div>
    <div class="actions">
      <button id="cancelNo" class="secondary">Tidak</button>
      <button id="cancelYes" class="danger">Ya, Hapus</button>
    </div>
  </dialog><script>
document.addEventListener('DOMContentLoaded', ()=>{
  const statusEl = document.getElementById('status') || document.body;
  function setStatus(txt){ if(statusEl) statusEl.textContent = 'Status: '+txt; console.log('STATUS:', txt); }

  // elemen
  const videoEl = document.getElementById('preview');
  const btnStart = document.getElementById('btnStart');
  const btnStop  = document.getElementById('btnStop');
  const btnSave  = document.getElementById('btnSave');
  const btnCancel= document.getElementById('btnCancel');
  const scanList = document.getElementById('scanList');
  const scanCount= document.getElementById('scanCount');
  const camLabel = document.getElementById('camLabel');

  const btnShow  = document.getElementById('btnShow');
  const emptyViewer = document.getElementById('emptyViewer');
  const itemViewer  = document.getElementById('itemViewer');

  const spanPLU = document.getElementById('plu');
  const spanName= document.getElementById('name');
  const spanRaw = document.getElementById('raw');
  const svgBarcode = document.getElementById('barcodeSvg');
  const imgProd  = document.getElementById('prodImg');
  const idxNow = document.getElementById('idxNow');
  const idxTotal = document.getElementById('idxTotal');
  const prevBtn = document.getElementById('prevBtn');
  const nextBtn = document.getElementById('nextBtn');

  const btnManual = document.getElementById('btnManual');
  const manualInput = document.getElementById('manualInput');

  const dlgCancel = document.getElementById('confirmCancel');

  // state
  const scanned = [];
  let saved = [];
  let currentIndex = 0;

  // products
  let products = [];
  let mapByBarcode = new Map();

  async function loadProducts(){
    try{
      const res = await fetch('bcd.json', {cache:'no-store'});
      if(!res.ok) throw new Error('HTTP '+res.status);
      products = await res.json();
      products.forEach(p=>{ if(p.BARCODE) mapByBarcode.set(String(p.BARCODE), p); });
      setStatus('bcd.json dimuat, item: '+products.length);
    }catch(e){
      console.warn('loadProducts error', e);
      setStatus('Tidak dapat memuat bcd.json â€” pencocokan nama akan kosong. ('+e.message+')');
    }
  }
  loadProducts();

  // cek ZXing
  let zxingAvailable = (typeof ZXing !== 'undefined') && ZXing && ZXing.BrowserMultiFormatReader;
  let codeReader = null;
  let scanActive = false;
  let lastText = '';
  let throttle = false;

  if(!zxingAvailable){
    setStatus('ZXing tidak ter-load. Scanner nonaktif. (CDN error / offline)');
    btnStart.disabled = true;
  } else {
    setStatus('Scanner siap (ZXing OK).');
  }

  // pasang listeners dulu (agar tombol selalu merespon)
  btnManual?.addEventListener('click', ()=>{
    const v = (manualInput.value||'').trim();
    if(!v) return;
    addScanned(v);
    manualInput.value='';
  });

  btnStart?.addEventListener('click', async ()=>{
    try{
      if(!zxingAvailable){ alert('Scanner tidak tersedia. Periksa koneksi/internet atau gunakan input manual.'); return; }
      if(scanActive) return;
      btnStart.disabled = true; btnStop.disabled=false; btnSave.disabled=false;
      if(!codeReader) codeReader = new ZXing.BrowserMultiFormatReader();
      const devices = await ZXing.BrowserMultiFormatReader.listVideoInputDevices();
      let deviceId = devices?.[0]?.deviceId || null;
      const back = devices.find(d=>/back|rear|belakang/i.test(d.label));
      if(back) deviceId = back.deviceId;
      camLabel.textContent = (devices.find(d=>d.deviceId===deviceId)?.label) || 'Kamera';
      scanActive = true; lastText='';
      setStatus('Scanner aktif â€” arahkan kamera ke barcode');
      await codeReader.decodeFromVideoDevice(deviceId, videoEl, (result, err)=>{
        if(!scanActive) return;
        if(result){
          const text = String(result.getText()).trim();
          if(throttle || text===lastText) return;
          throttle=true; setTimeout(()=>throttle=false, 350);
          lastText = text; addScanned(text);
        } else if(err && !(err instanceof ZXing.NotFoundException)){
          console.error('scanner err', err);
        }
      });
    }catch(err){
      console.error('startScan err', err);
      setStatus('Gagal mulai scanner: '+(err.message||err));
      btnStart.disabled=false; btnStop.disabled=true;
    }
  });

  btnStop?.addEventListener('click', ()=>{ stopScan(); });

  btnSave?.addEventListener('click', ()=>{
    saved = scanned.slice(); currentIndex = 0;
    btnShow.disabled = saved.length===0;
    if(saved.length>0) showViewer();
    setStatus('Hasil disimpan: '+saved.length+' item');
  });

  btnCancel?.addEventListener('click', ()=>{
    try{
      if(dlgCancel && typeof dlgCancel.showModal === 'function') dlgCancel.showModal();
      else if(confirm('Batalkan & hapus hasil sementara?')) performCancel();
    }catch(e){ if(confirm('Batalkan & hapus hasil sementara?')) performCancel(); }
  });

  window.addEventListener('error', (ev)=>{ console.error('window error', ev); setStatus('Error: '+(ev.error?.message||ev.message||'unknown')); });

  function performCancel(){ stopScan(); scanned.length=0; renderScanList(); btnSave.disabled=true; btnShow.disabled=saved.length===0; setStatus('Hasil sementara dibatalkan'); }
  function stopScan(){ scanActive=false; try{ codeReader?.reset(); }catch(e){}; btnStart.disabled = !zxingAvailable; btnStop.disabled=true; setStatus('Scanner dihentikan'); }
  function addScanned(code){ if(!code) return; code = String(code).trim(); if(!scanned.includes(code)){ scanned.push(code); renderScanList(); setStatus('Barcode ditambahkan: '+code); } else setStatus('Barcode sudah ada: '+code); }
  function renderScanList(){ scanList.innerHTML=''; scanned.forEach((c,i)=>{ const s=document.createElement('span'); s.className='pill mono'; s.textContent=(i+1)+'. '+c; scanList.appendChild(s); }); scanCount.textContent = scanned.length; btnSave.disabled = scanned.length===0; }

  function showViewer(){ emptyViewer.style.display='none'; itemViewer.style.display=''; idxTotal.textContent=saved.length; renderViewer(currentIndex); }
  function guessFormat(code){ if(/^\d{13}$/.test(code)) return 'EAN13'; if(/^\d{8}$/.test(code)) return 'EAN8'; return 'CODE128'; }

  function lookupProduct(code){
    if(mapByBarcode.has(code)) return mapByBarcode.get(code);
    const trimmed = code.replace(/^0+/, '');
    for(const p of products){ if(String(p.BARCODE)===code || String(p.BARCODE)===trimmed || String(p.PLU)===code) return p; }
    return { PLU:'', NAMA_PRODUK: '(Produk tidak ditemukan di bcd.json)', BARCODE: code };
  }

  function renderViewer(i){
    if(saved.length===0) return; if(i<0) i=0; if(i>saved.length-1) i=saved.length-1; currentIndex=i;
    const code = saved[i]; const info = lookupProduct(code) || {};
    const plu = info.PLU || (/^\d{8}$/.test(code) ? code : '');
    const name = info.NAMA_PRODUK || '(Nama tidak tersedia)';
    spanPLU.textContent = plu || '-'; spanName.textContent = name; spanRaw.textContent = code;
    svgBarcode.innerHTML=''; try{ JsBarcode(svgBarcode, code, { format: guessFormat(code), displayValue:true, fontSize:14, margin:6, height:80 }); }catch(e){ try{ JsBarcode(svgBarcode, code, { format:'CODE128', displayValue:true, fontSize:14, margin:6, height:80 }); }catch(_){} }
    if(plu){ imgProd.src = `https://cdn-klik.klikindomaret.com/klik-catalog/product/${plu}_1.jpg`; imgProd.style.display=''; } else { imgProd.removeAttribute('src'); imgProd.style.display='none'; }
    idxNow.textContent = i+1; idxTotal.textContent = saved.length; prevBtn.disabled = (i===0); nextBtn.disabled = (i===saved.length-1);
  }

  // hint
  setStatus('Siap. Tes: tekan tombol Tambah (manual) dulu. Untuk kamera, buka lewat HTTPS / server lokal.');
});
              </script>
</body>
</html>
