<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>‚ö° Lightning Scanner</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/quagga/0.12.1/quagga.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/zxing-js/0.20.0/index.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jsbarcode/3.11.5/JsBarcode.all.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: #333;
            padding: 10px;
        }

        .container {
            max-width: 400px;
            margin: 0 auto;
        }

        .header {
            text-align: center;
            color: white;
            margin-bottom: 20px;
        }

        .header h1 {
            font-size: 24px;
            margin-bottom: 5px;
        }

        .scanner-card {
            background: white;
            border-radius: 15px;
            padding: 20px;
            box-shadow: 0 10px 25px rgba(0,0,0,0.2);
            margin-bottom: 15px;
        }

        .scanner-container {
            position: relative;
            background: #000;
            border-radius: 10px;
            overflow: hidden;
            margin-bottom: 15px;
            height: 300px;
        }

        #scanner {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .scan-box {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 200px;
            height: 80px;
            border: 3px solid #00ff00;
            border-radius: 8px;
            box-shadow: 
                0 0 0 2px rgba(0,255,0,0.3),
                0 0 0 99999px rgba(0,0,0,0.6);
        }

        .scan-line {
            position: absolute;
            top: 50%;
            left: 10px;
            right: 10px;
            height: 2px;
            background: linear-gradient(90deg, transparent, #00ff00, transparent);
            animation: scanMove 1.5s linear infinite;
        }

        @keyframes scanMove {
            0% { transform: translateY(-40px); opacity: 0; }
            50% { opacity: 1; }
            100% { transform: translateY(40px); opacity: 0; }
        }

        .stats {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
            font-size: 12px;
        }

        .stat {
            flex: 1;
            background: #f8f9fa;
            padding: 8px;
            border-radius: 6px;
            text-align: center;
        }

        .stat-num {
            font-weight: bold;
            font-size: 16px;
            color: #4CAF50;
        }

        .controls {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
        }

        .btn {
            flex: 1;
            padding: 12px;
            border: none;
            border-radius: 8px;
            font-weight: bold;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.2s;
        }

        .btn-start {
            background: linear-gradient(135deg, #4CAF50, #45a049);
            color: white;
        }

        .btn-stop {
            background: linear-gradient(135deg, #ff6b6b, #ee5a52);
            color: white;
        }

        .btn-action {
            background: linear-gradient(135deg, #74b9ff, #0984e3);
            color: white;
        }

        .btn:hover:not(:disabled) {
            transform: translateY(-1px);
        }

        .btn:disabled {
            background: #ccc !important;
            cursor: not-allowed;
            transform: none;
        }

        .status {
            text-align: center;
            padding: 10px;
            border-radius: 6px;
            font-size: 13px;
            font-weight: bold;
            margin-bottom: 10px;
            display: none;
        }

        .success { background: #d4edda; color: #155724; }
        .error { background: #f8d7da; color: #721c24; }
        .warning { background: #fff3cd; color: #856404; }

        .results-section {
            display: none;
        }

        .product-card {
            background: white;
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 15px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
            border-left: 4px solid #4CAF50;
        }

        .plu {
            font-size: 18px;
            font-weight: bold;
            color: #4CAF50;
            margin-bottom: 5px;
        }

        .product-name {
            font-size: 14px;
            color: #333;
            margin-bottom: 10px;
            line-height: 1.4;
        }

        .product-image {
            width: 100px;
            height: 100px;
            object-fit: cover;
            border-radius: 6px;
            margin: 10px auto;
            display: block;
        }

        .barcode-display {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 6px;
            text-align: center;
        }

        .navigation {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin: 15px 0;
        }

        .nav-btn {
            padding: 8px 15px;
            background: #74b9ff;
            color: white;
            border: none;
            border-radius: 20px;
            cursor: pointer;
            font-size: 12px;
        }

        .nav-btn:disabled {
            background: #ccc;
            cursor: not-allowed;
        }

        .back-btn {
            position: fixed;
            bottom: 20px;
            right: 20px;
            width: 50px;
            height: 50px;
            background: #4CAF50;
            border: none;
            border-radius: 50%;
            color: white;
            font-size: 20px;
            cursor: pointer;
            box-shadow: 0 5px 15px rgba(0,0,0,0.3);
            display: none;
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.8);
            z-index: 1000;
        }

        .modal-content {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: white;
            padding: 20px;
            border-radius: 10px;
            text-align: center;
            max-width: 300px;
            width: 90%;
        }

        .modal-buttons {
            display: flex;
            gap: 10px;
            margin-top: 15px;
        }

        @media (max-width: 480px) {
            .container { padding: 5px; }
            .scan-box { width: 180px; height: 70px; }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>‚ö° Lightning Scanner</h1>
            <p>Instant barcode detection</p>
        </div>

        <!-- Scanner Section -->
        <div id="scanner-section">
            <div class="scanner-card">
                <div class="scanner-container">
                    <video id="scanner" autoplay playsinline muted></video>
                    <canvas id="canvas" style="display: none;"></canvas>
                    <div class="scan-box">
                        <div class="scan-line"></div>
                    </div>
                </div>
                
                <div class="stats">
                    <div class="stat">
                        <div class="stat-num" id="count">0</div>
                        <div>Scanned</div>
                    </div>
                    <div class="stat">
                        <div class="stat-num" id="speed">0</div>
                        <div>ms</div>
                    </div>
                    <div class="stat">
                        <div class="stat-num" id="fps">0</div>
                        <div>FPS</div>
                    </div>
                </div>
                
                <div class="status" id="status"></div>
                
                <div class="controls">
                    <button class="btn btn-start" id="start">üöÄ START</button>
                    <button class="btn btn-stop" id="stop" disabled>‚èπÔ∏è STOP</button>
                </div>
                
                <div class="controls">
                    <button class="btn btn-action" id="save" disabled>üíæ Save</button>
                    <button class="btn btn-stop" id="reset">üîÑ Reset</button>
                </div>
                
                <div class="controls" style="display: none;" id="show-results-btn">
                    <button class="btn btn-action" id="show-results">üìã Results</button>
                </div>
            </div>
        </div>

        <!-- Results Section -->
        <div id="results-section" class="results-section">
            <div class="navigation">
                <button class="nav-btn" id="prev">‚Äπ Prev</button>
                <span id="page-info">1 / 1</span>
                <button class="nav-btn" id="next">Next ‚Ä∫</button>
            </div>
            
            <div id="products"></div>
            
            <div class="navigation">
                <button class="nav-btn" id="prev2">‚Äπ Prev</button>
                <span id="page-info2">1 / 1</span>
                <button class="nav-btn" id="next2">Next ‚Ä∫</button>
            </div>
        </div>

        <button class="back-btn" id="back">üîô</button>
    </div>

    <!-- Modal -->
    <div id="modal" class="modal">
        <div class="modal-content">
            <h3>Reset All?</h3>
            <p>Clear all scanned barcodes?</p>
            <div class="modal-buttons">
                <button class="btn btn-stop" id="confirm-reset">Yes</button>
                <button class="btn btn-action" id="cancel-reset">Cancel</button>
            </div>
        </div>
    </div>

    <script>
        class LightningScanner {
            constructor() {
                this.scannedBarcodes = [];
                this.products = new Map();
                this.currentPage = 0;
                this.isScanning = false;
                this.scanCooldown = false;
                this.stream = null;
                this.animFrame = null;
                this.codeReader = null;
                
                this.frameCount = 0;
                this.lastFPSTime = Date.now();
                
                this.init();
            }

            init() {
                this.bindEvents();
                this.loadProducts();
                this.initZXing();
            }

            initZXing() {
                try {
                    if (typeof ZXing !== 'undefined') {
                        this.codeReader = new ZXing.BrowserMultiFormatReader();
                        this.codeReader.timeBetweenDecodingAttempts = 50;
                        console.log('‚ö° ZXing ready');
                    }
                } catch (e) {
                    console.warn('ZXing failed');
                }
            }

            async loadProducts() {
                try {
                    const response = await fetch('./bcd.json');
                    const data = await response.json();
                    
                    data.forEach(item => {
                        if (item.BARCODE) {
                            this.products.set(item.BARCODE, item);
                        }
                    });
                    
                    this.showStatus(`üì¶ ${data.length} products loaded`, 'success');
                } catch (e) {
                    this.showStatus('Using sample data', 'warning');
                    
                    const sampleData = [
                        {"PLU": "10000019", "NAMA_PRODUK": "INDOMILK SUSU KENTAL MANIS PUTIH 370g", "BARCODE": "8992702000018"},
                        {"PLU": "10000020", "NAMA_PRODUK": "INDOMILK SUSU KENTAL MANIS COKLAT 370g", "BARCODE": "8992702000063"}
                    ];
                    
                    sampleData.forEach(item => {
                        this.products.set(item.BARCODE, item);
                    });
                }
            }

            bindEvents() {
                document.getElementById('start').onclick = () => this.startScanner();
                document.getElementById('stop').onclick = () => this.stopScanner();
                document.getElementById('save').onclick = () => this.saveResults();
                document.getElementById('reset').onclick = () => this.showResetModal();
                document.getElementById('show-results').onclick = () => this.showResults();
                document.getElementById('back').onclick = () => this.backToScanner();
                
                document.getElementById('confirm-reset').onclick = () => this.confirmReset();
                document.getElementById('cancel-reset').onclick = () => this.hideModal();
                
                document.getElementById('prev').onclick = () => this.prevPage();
                document.getElementById('next').onclick = () => this.nextPage();
                document.getElementById('prev2').onclick = () => this.prevPage();
                document.getElementById('next2').onclick = () => this.nextPage();
                
                document.getElementById('modal').onclick = (e) => {
                    if (e.target.id === 'modal') this.hideModal();
                };
            }

            async startScanner() {
                try {
                    const video = document.getElementById('scanner');
                    const canvas = document.getElementById('canvas');
                    const ctx = canvas.getContext('2d');

                    this.stream = await navigator.mediaDevices.getUserMedia({
                        video: {
                            facingMode: { ideal: 'environment' },
                            width: { ideal: 1280 },
                            height: { ideal: 720 },
                            frameRate: { ideal: 30 }
                        }
                    });

                    video.srcObject = this.stream;
                    await video.play();

                    canvas.width = video.videoWidth;
                    canvas.height = video.videoHeight;

                    this.isScanning = true;
                    document.getElementById('start').disabled = true;
                    document.getElementById('stop').disabled = false;
                    
                    this.showStatus('üöÄ SCANNING ACTIVE', 'success');
                    this.startScanLoop(video, canvas, ctx);
                    
                } catch (e) {
                    this.showStatus('‚ùå Camera access failed', 'error');
                }
            }

            startScanLoop(video, canvas, ctx) {
                let lastScan = 0;
                
                const loop = (time) => {
                    if (!this.isScanning) return;
                    
                    this.frameCount++;
                    this.updateFPS();
                    
                    // Scan 20 times per second max
                    if (time - lastScan > 50) {
                        this.performScan(video, canvas, ctx);
                        lastScan = time;
                    }
                    
                    this.animFrame = requestAnimationFrame(loop);
                };
                
                this.animFrame = requestAnimationFrame(loop);
            }

            performScan(video, canvas, ctx) {
                if (this.scanCooldown) return;
                
                const startTime = performance.now();
                
                // Draw only the scan area (200x80 center box)
                const centerX = canvas.width / 2;
                const centerY = canvas.height / 2;
                const scanWidth = 200;
                const scanHeight = 80;
                
                const sourceX = centerX - scanWidth / 2;
                const sourceY = centerY - scanHeight / 2;
                
                ctx.drawImage(video, sourceX, sourceY, scanWidth, scanHeight, 0, 0, scanWidth, scanHeight);
                const imageData = ctx.getImageData(0, 0, scanWidth, scanHeight);
                
                // Quick barcode pattern check first
                if (this.hasBarcodePattern(imageData)) {
                    this.scanWithZXing(imageData);
                }
                
                const scanTime = Math.round(performance.now() - startTime);
                document.getElementById('speed').textContent = scanTime;
            }

            hasBarcodePattern(imageData) {
                const data = imageData.data;
                const width = imageData.width;
                const height = imageData.height;
                
                // Check center line for barcode pattern
                const y = Math.floor(height / 2);
                const lineStart = y * width * 4;
                
                let transitions = 0;
                let lastIsLight = false;
                
                for (let x = 0; x < width; x += 2) {
                    const pixelIndex = lineStart + (x * 4);
                    const brightness = (data[pixelIndex] + data[pixelIndex + 1] + data[pixelIndex + 2]) / 3;
                    const isLight = brightness > 128;
                    
                    if (isLight !== lastIsLight) {
                        transitions++;
                    }
                    lastIsLight = isLight;
                }
                
                return transitions > 8 && transitions < 50;
            }

            scanWithZXing(imageData) {
                if (!this.codeReader) return;
                
                this.codeReader.decodeFromImageData(imageData)
                    .then(result => {
                        if (result && result.text) {
                            this.onBarcodeFound(result.text);
                        }
                    })
                    .catch(() => {
                        // Silent fail - try Quagga fallback if needed
                        this.fallbackQuagga(imageData);
                    });
            }

            fallbackQuagga(imageData) {
                if (typeof Quagga === 'undefined') return;
                
                const canvas = document.createElement('canvas');
                canvas.width = imageData.width;
                canvas.height = imageData.height;
                const ctx = canvas.getContext('2d');
                ctx.putImageData(imageData, 0, 0);
                
                Quagga.decodeSingle({
                    src: canvas.toDataURL(),
                    numOfWorkers: 0,
                    decoder: {
                        readers: ["ean_reader", "code_128_reader", "upc_reader"]
                    }
                }, (result) => {
                    if (result && result.codeResult) {
                        this.onBarcodeFound(result.codeResult.code);
                    }
                });
            }

            onBarcodeFound(barcode) {
                if (this.scanCooldown) return;
                
                barcode = barcode.replace(/[^0-9]/g, '');
                if (barcode.length < 8) return;
                
                this.scanCooldown = true;
                setTimeout(() => this.scanCooldown = false, 300);
                
                if (!this.scannedBarcodes.includes(barcode)) {
                    this.scannedBarcodes.push(barcode);
                    this.updateCount();
                    this.successFeedback(barcode);
                } else {
                    this.showStatus(`‚ö†Ô∏è ${barcode} already scanned`, 'warning');
                    this.errorFeedback();
                }
            }

            successFeedback(barcode) {
                const product = this.products.get(barcode);
                const name = product ? product.NAMA_PRODUK.substring(0, 25) + '...' : 'Unknown';
                
                this.showStatus(`‚úÖ ${name}`, 'success');
                this.flashScanBox('#00ff00');
                this.playBeep(800, 0.2);
                this.vibrate([100, 50, 100]);
            }

            errorFeedback() {
                this.flashScanBox('#ff6b6b');
                this.vibrate([50, 30, 50]);
            }

            flashScanBox(color) {
                const box = document.querySelector('.scan-box');
                box.style.borderColor = color;
                box.style.boxShadow = `0 0 0 2px ${color}33, 0 0 0 99999px rgba(0,0,0,0.6)`;
                
                setTimeout(() => {
                    box.style.borderColor = '#00ff00';
                    box.style.boxShadow = '0 0 0 2px rgba(0,255,0,0.3), 0 0 0 99999px rgba(0,0,0,0.6)';
                }, 200);
            }

            playBeep(freq, duration) {
                try {
                    const ctx = new (window.AudioContext || window.webkitAudioContext)();
                    const osc = ctx.createOscillator();
                    const gain = ctx.createGain();
                    
                    osc.connect(gain);
                    gain.connect(ctx.destination);
                    
                    osc.frequency.value = freq;
                    gain.gain.setValueAtTime(0.1, ctx.currentTime);
                    gain.gain.exponentialRampToValueAtTime(0.01, ctx.currentTime + duration);
                    
                    osc.start();
                    osc.stop(ctx.currentTime + duration);
                } catch (e) {}
            }

            vibrate(pattern) {
                if ('vibrate' in navigator) {
                    navigator.vibrate(pattern);
                }
            }

            updateFPS() {
                const now = Date.now();
                if (now - this.lastFPSTime >= 1000) {
                    const fps = Math.round((this.frameCount * 1000) / (now - this.lastFPSTime));
                    document.getElementById('fps').textContent = fps;
                    this.frameCount = 0;
                    this.lastFPSTime = now;
                }
            }

            updateCount() {
                document.getElementById('count').textContent = this.scannedBarcodes.length;
                document.getElementById('save').disabled = this.scannedBarcodes.length === 0;
            }

            stopScanner() {
                this.isScanning = false;
                
                if (this.animFrame) {
                    cancelAnimationFrame(this.animFrame);
                }
                
                if (this.stream) {
                    this.stream.getTracks().forEach(track => track.stop());
                }
                
                if (this.codeReader) {
                    this.codeReader.reset();
                }
                
                document.getElementById('start').disabled = false;
                document.getElementById('stop').disabled = true;
                document.getElementById('scanner').srcObject = null;
                
                this.showStatus('üõë Scanner stopped', 'error');
            }

            saveResults() {
                if (this.scannedBarcodes.length === 0) return;
                
                this.stopScanner();
                document.getElementById('show-results-btn').style.display = 'block';
                this.showStatus(`üíæ ${this.scannedBarcodes.length} items saved`, 'success');
            }

            showResetModal() {
                document.getElementById('modal').style.display = 'block';
            }

            hideModal() {
                document.getElementById('modal').style.display = 'none';
            }

            confirmReset() {
                this.scannedBarcodes = [];
                this.updateCount();
                this.stopScanner();
                document.getElementById('show-results-btn').style.display = 'none';
                this.hideModal();
                this.showStatus('üîÑ Reset complete', 'warning');
            }

            showResults() {
                document.getElementById('scanner-section').style.display = 'none';
                document.getElementById('results-section').style.display = 'block';
                document.getElementById('back').style.display = 'block';
                this.currentPage = 0;
                this.renderResults();
            }

            backToScanner() {
                document.getElementById('scanner-section').style.display = 'block';
                document.getElementById('results-section').style.display = 'none';
                document.getElementById('back').style.display = 'none';
            }

            renderResults() {
                const container = document.getElementById('products');
                container.innerHTML = '';
                
                if (this.scannedBarcodes.length === 0) return;
                
                const barcode = this.scannedBarcodes[this.currentPage];
                const product = this.products.get(barcode);
                
                const card = document.createElement('div');
                card.className = 'product-card';
                
                const plu = product ? product.PLU : 'Not Found';
                const name = product ? product.NAMA_PRODUK : `Product ${barcode} not in database`;
                const imgUrl = product ? `https://cdn-klik.klikindomaret.com/klik-catalog/product/${product.PLU}_1.jpg` : '';
                
                card.innerHTML = `
                    <div class="plu">PLU: ${plu}</div>
                    <div class="product-name">${name}</div>
                    ${product ? `<img class="product-image" src="${imgUrl}" onerror="this.style.display='none'">` : ''}
                    <div class="barcode-display">
                        <svg id="barcode-${barcode}" width="100%" height="60"></svg>
                    </div>
                `;
                
                container.appendChild(card);
                
                setTimeout(() => {
                    try {
                        JsBarcode(`#barcode-${barcode}`, barcode, {
                            format: "EAN13",
                            width: 1.5,
                            height: 50,
                            displayValue: true,
                            fontSize: 12
                        });
                    } catch (e) {
                        try {
                            JsBarcode(`#barcode-${barcode}`, barcode, {
                                format: "CODE128",
                                width: 1.5,
                                height: 50,
                                displayValue: true,
                                fontSize: 12
                            });
                        } catch (e2) {
                            document.querySelector(`#barcode-${barcode}`).innerHTML = 
                                `<text x="50%" y="30" text-anchor="middle">${barcode}</text>`;
                        }
                    }
                }, 100);
                
                this.updatePagination();
            }

            updatePagination() {
                const total = this.scannedBarcodes.length;
                const current = this.currentPage + 1;
                
                document.getElementById('page-info').textContent = `${current} / ${total}`;
                document.getElementById('page-info2').textContent = `${current} / ${total}`;
                
                document.getElementById('prev').disabled = this.currentPage === 0;
                document.getElementById('next').disabled = this.currentPage >= total - 1;
                document.getElementById('prev2').disabled = this.currentPage === 0;
                document.getElementById('next2').disabled = this.currentPage >= total - 1;
            }

            prevPage() {
                if (this.currentPage > 0) {
                    this.currentPage--;
                    this.renderResults();
                }
            }

            nextPage() {
                if (this.currentPage < this.scannedBarcodes.length - 1) {
                    this.currentPage++;
                    this.renderResults();
                }
            }

            showStatus(message, type) {
                const status = document.getElementById('status');
                status.textContent = message;
                status.className = `status ${type}`;
                status.style.display = 'block';
                
                setTimeout(() => {
                    status.style.display = 'none';
                }, 3000);
            }
        }

        document.addEventListener('DOMContentLoaded', () => {
            new LightningScanner();
        });
    </script>
</body>
</html>
