<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Indomaret Photo Editor - BY WHYUU</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Arial', sans-serif;
            background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .header {
            text-align: center;
            color: white;
            margin-bottom: 30px;
        }

        .header h1 {
            font-size: 2.5rem;
            font-weight: bold;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
            margin-bottom: 10px;
        }

        .header p {
            font-size: 1.2rem;
            opacity: 0.9;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
        }

        .card {
            background: white;
            border-radius: 15px;
            padding: 25px;
            margin-bottom: 20px;
            box-shadow: 0 10px 25px rgba(0,0,0,0.1);
            transition: transform 0.3s ease;
        }

        .card:hover {
            transform: translateY(-5px);
        }

        .card-header {
            text-align: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 2px solid #f0f0f0;
        }

        .card-number {
            background: linear-gradient(45deg, #1e3c72, #2a5298);
            color: white;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto 10px;
            font-weight: bold;
            font-size: 1.2rem;
        }

        .input-group {
            margin-bottom: 20px;
        }

        .input-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: bold;
            color: #333;
        }

        .input-group input[type="text"] {
            width: 100%;
            padding: 12px;
            border: 2px solid #ddd;
            border-radius: 8px;
            font-size: 16px;
            transition: border-color 0.3s ease;
        }

        .input-group input[type="text"]:focus {
            outline: none;
            border-color: #1e3c72;
        }

        .photo-inputs {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 20px;
        }

        .photo-input {
            text-align: center;
        }

        .photo-input label {
            display: block;
            margin-bottom: 10px;
            font-weight: bold;
            color: #333;
        }

        .file-input-wrapper {
            position: relative;
            display: inline-block;
            cursor: pointer;
            width: 100%;
        }

        .file-input {
            display: none;
        }

        .file-input-button {
            display: block;
            padding: 12px 20px;
            background: linear-gradient(45deg, #1e3c72, #2a5298);
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
            width: 100%;
            font-size: 14px;
        }

        .file-input-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(30, 60, 114, 0.4);
        }

        .preview-container {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-top: 15px;
        }

        .preview {
            width: 100%;
            height: 200px;
            border: 2px dashed #ddd;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #999;
            font-size: 14px;
            background: #f9f9f9;
        }

        .preview img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            border-radius: 6px;
        }

        .process-all-button {
            background: linear-gradient(45deg, #28a745, #20c997);
            color: white;
            border: none;
            padding: 18px 40px;
            font-size: 1.2rem;
            font-weight: bold;
            border-radius: 50px;
            cursor: pointer;
            transition: all 0.3s ease;
            display: block;
            margin: 30px auto;
            box-shadow: 0 8px 20px rgba(40, 167, 69, 0.3);
        }

        .process-all-button:hover {
            transform: translateY(-3px);
            box-shadow: 0 12px 25px rgba(40, 167, 69, 0.4);
        }

        .process-all-button:disabled {
            background: #ccc;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        .loading {
            display: none;
            text-align: center;
            margin: 20px 0;
        }

        .spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #1e3c72;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 2s linear infinite;
            margin: 0 auto;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .results-section {
            margin-top: 40px;
        }

        .result-card {
            background: white;
            border-radius: 15px;
            padding: 25px;
            margin-bottom: 20px;
            box-shadow: 0 10px 25px rgba(0,0,0,0.1);
            text-align: center;
        }

        .result-canvas {
            max-width: 100%;
            height: auto;
            border-radius: 10px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
            margin-bottom: 20px;
        }

        .download-button {
            background: linear-gradient(45deg, #dc3545, #fd7e14);
            color: white;
            border: none;
            padding: 12px 30px;
            font-size: 1rem;
            font-weight: bold;
            border-radius: 25px;
            cursor: pointer;
            transition: all 0.3s ease;
            margin: 5px;
        }

        .download-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(220, 53, 69, 0.4);
        }

        .progress-info {
            background: #e3f2fd;
            border-radius: 8px;
            padding: 15px;
            margin: 10px 0;
            color: #1976d2;
            font-weight: bold;
        }

        @media (max-width: 768px) {
            .photo-inputs, .preview-container {
                grid-template-columns: 1fr;
            }
            .header h1 {
                font-size: 2rem;
            }
            .card {
                padding: 20px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>BY WHYUU</h1>
            <p>Indomaret Photo Editor</p>
        </div>

        <div class="card">
            <div class="card-header">
                <div class="card-number">üè™</div>
                <h3>Nama Toko Global</h3>
            </div>
            <div class="input-group">
                <label for="global-store-name">Nama Toko (untuk semua kartu):</label>
                <input type="text" id="global-store-name" placeholder="Masukkan nama toko (contoh: TACCIPI BONE)" value="TACCIPI BONE">
                <p style="margin-top: 10px; color: #666; font-size: 14px;">
                    Hasil: <strong>INDOMARET:<span id="store-preview">TACCIPI BONE</span></strong>
                </p>
            </div>
        </div>

        <div id="editor-cards"></div>

        <button class="process-all-button" onclick="processAllPhotos()">
            BUAT SEMUA FOTO
        </button>

        <div class="loading" id="loading">
            <div class="spinner"></div>
            <p>Memproses foto...</p>
            <div class="progress-info" id="progress-info">
                Mempersiapkan proses...
            </div>
        </div>

        <div class="results-section" id="results"></div>
    </div>

    <script>
        // Global variable untuk menyimpan canvas hasil
        const processedCanvases = new Map();

        function generateCards() {
            const container = document.getElementById('editor-cards');
            let cardsHTML = '';
            for (let i = 1; i <= 8; i++) {
                cardsHTML += `
                    <div class="card">
                        <div class="card-header">
                            <div class="card-number">${i}</div>
                            <h3>Editor Foto ${i}</h3>
                        </div>
                        <div class="photo-inputs">
                            <div class="photo-input">
                                <label>Foto Contoh:</label>
                                <div class="file-input-wrapper">
                                    <input type="file" id="contoh-${i}" class="file-input" accept="image/*" onchange="previewImage(this, 'contoh-preview-${i}')">
                                    <label for="contoh-${i}" class="file-input-button">Upload Foto Contoh</label>
                                </div>
                            </div>
                            <div class="photo-input">
                                <label>Foto Realisasi:</label>
                                <div class="file-input-wrapper">
                                    <input type="file" id="realisasi-${i}" class="file-input" accept="image/*" onchange="previewImage(this, 'realisasi-preview-${i}')">
                                    <label for="realisasi-${i}" class="file-input-button">Upload Foto Realisasi</label>
                                </div>
                            </div>
                        </div>
                        <div class="preview-container">
                            <div class="preview" id="contoh-preview-${i}">Preview Foto Contoh</div>
                            <div class="preview" id="realisasi-preview-${i}">Preview Foto Realisasi</div>
                        </div>
                    </div>
                `;
            }
            container.innerHTML = cardsHTML;
        }

        function previewImage(input, previewId) {
            const preview = document.getElementById(previewId);
            const file = input.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    preview.innerHTML = `<img src="${e.target.result}" alt="Preview">`;
                };
                reader.readAsDataURL(file);
            }
        }
        
        async function processAllPhotos() {
            const loading = document.getElementById('loading');
            const results = document.getElementById('results');
            const button = document.querySelector('.process-all-button');
            const progressInfo = document.getElementById('progress-info');
            const globalStoreName = document.getElementById('global-store-name').value.trim();

            if (!globalStoreName) {
                alert('Mohon isi nama toko terlebih dahulu!');
                return;
            }

            // Reset state
            processedCanvases.clear();
            loading.style.display = 'block';
            button.disabled = true;
            results.innerHTML = '';

            // Cari kartu yang memiliki foto
            let validCards = [];
            for (let i = 1; i <= 8; i++) {
                const contohFile = document.getElementById(`contoh-${i}`).files[0];
                const realisasiFile = document.getElementById(`realisasi-${i}`).files[0];
                if (contohFile && realisasiFile) {
                    validCards.push(i);
                }
            }

            if (validCards.length === 0) {
                alert('Mohon upload foto contoh dan realisasi pada minimal satu kartu!');
                loading.style.display = 'none';
                button.disabled = false;
                return;
            }

            progressInfo.textContent = `Ditemukan ${validCards.length} foto untuk diproses...`;

            // Proses foto satu per satu dengan delay untuk mencegah overload
            for (let index = 0; index < validCards.length; index++) {
                const cardNumber = validCards[index];
                progressInfo.textContent = `Memproses foto ${index + 1} dari ${validCards.length} (Kartu ${cardNumber})...`;
                
                const contohFile = document.getElementById(`contoh-${cardNumber}`).files[0];
                const realisasiFile = document.getElementById(`realisasi-${cardNumber}`).files[0];
                
                try {
                    const canvas = await createComparisonImage(globalStoreName, contohFile, realisasiFile);
                    processedCanvases.set(cardNumber, canvas);
                    displayResult(canvas, cardNumber, globalStoreName);
                    
                    console.log(`Berhasil memproses foto ${cardNumber}`);
                } catch (error) {
                    console.error(`Error processing card ${cardNumber}:`, error);
                    displayErrorResult(cardNumber, globalStoreName, error.message);
                }
                
                // Delay untuk mencegah browser overload
                await new Promise(resolve => setTimeout(resolve, 500));
            }

            progressInfo.textContent = `Selesai! ${processedCanvases.size} foto berhasil dibuat.`;
            
            // Hide loading setelah semua selesai
            setTimeout(() => {
                loading.style.display = 'none';
                button.disabled = false;
            }, 1000);
        }

        // Fungsi untuk memuat gambar dari file dengan error handling yang lebih baik
        function loadUserImage(file) {
            return new Promise((resolve, reject) => {
                if (!file) {
                    reject(new Error('File tidak ditemukan'));
                    return;
                }

                const img = new Image();
                const url = URL.createObjectURL(file);
                
                img.onload = function() {
                    URL.revokeObjectURL(url); // Hapus URL dari memori
                    resolve(this);
                };
                
                img.onerror = function() {
                    URL.revokeObjectURL(url);
                    reject(new Error(`Gagal memuat file: ${file.name}`));
                };
                
                img.src = url;
            });
        }

        // Fungsi untuk membuat template sesuai gambar yang diberikan dengan background Indomaret
        function createBaseTemplate(width, height, storeName) {
            const canvas = document.createElement('canvas');
            const ctx = canvas.getContext('2d');
            
            canvas.width = width;
            canvas.height = height;
            
            // Background biru dengan gradient dan pattern seperti toko Indomaret
            const gradient = ctx.createLinearGradient(0, 0, width, height);
            gradient.addColorStop(0, '#4169E1');
            gradient.addColorStop(0.3, '#5B7CE6');
            gradient.addColorStop(0.7, '#6495ED');
            gradient.addColorStop(1, '#1E90FF');
            ctx.fillStyle = gradient;
            ctx.fillRect(0, 0, width, height);
            
            // Tambahkan efek visual seperti background toko Indomaret
            drawIndomaretBackground(ctx, width, height);
            
            // Area header putih untuk nama toko (sesuai template)
            const headerX = width * 0.05;
            const headerY = height * 0.05;
            const headerWidth = width * 0.9;
            const headerHeight = height * 0.12;
            
            ctx.fillStyle = 'white';
            ctx.fillRect(headerX, headerY, headerWidth, headerHeight);
            ctx.strokeStyle = '#333333';
            ctx.lineWidth = 2;
            ctx.strokeRect(headerX, headerY, headerWidth, headerHeight);
            
            // Teks "INDOMARET:" pada header
            ctx.fillStyle = 'black';
            const fontSize = Math.floor(height * 0.04);
            ctx.font = `bold ${fontSize}px Arial`;
            ctx.textAlign = 'left';
            const textX = headerX + width * 0.02;
            const textY = headerY + headerHeight * 0.65;
            ctx.fillText(`INDOMARET: ${storeName.toUpperCase()}`, textX, textY);
            
            // Area utama putih untuk foto (sesuai template)
            const mainAreaX = width * 0.05;
            const mainAreaY = height * 0.22;
            const mainAreaWidth = width * 0.9;
            const mainAreaHeight = height * 0.73;
            
            ctx.fillStyle = 'white';
            ctx.fillRect(mainAreaX, mainAreaY, mainAreaWidth, mainAreaHeight);
            ctx.strokeStyle = '#333333';
            ctx.lineWidth = 2;
            ctx.strokeRect(mainAreaX, mainAreaY, mainAreaWidth, mainAreaHeight);
            
            // Garis pembagi tengah
            const centerX = width / 2;
            ctx.beginPath();
            ctx.moveTo(centerX, mainAreaY);
            ctx.lineTo(centerX, mainAreaY + mainAreaHeight);
            ctx.stroke();
            
            // Label "CONTOH" dan "REALISASI" (sesuai template)
            ctx.fillStyle = 'black';
            const labelFontSize = Math.floor(height * 0.035);
            ctx.font = `bold ${labelFontSize}px Arial`;
            ctx.textAlign = 'center';
            
            const labelY = mainAreaY + labelFontSize + 10;
            ctx.fillText('CONTOH', mainAreaX + (mainAreaWidth * 0.25), labelY);
            ctx.fillText('REALISASI', mainAreaX + (mainAreaWidth * 0.75), labelY);
            
            return canvas;
        }

        // Fungsi untuk menggambar background visual seperti toko Indomaret
        function drawIndomaretBackground(ctx, width, height) {
            // Simpan state context
            ctx.save();
            
            // Set opacity untuk background elements
            ctx.globalAlpha = 0.3;
            
            // Gambar bentuk-bentuk geometris yang menyerupai elemen toko
            // Bentuk diagonal (seperti atap atau struktur bangunan)
            ctx.fillStyle = '#FF6B35'; // Orange Indomaret
            ctx.beginPath();
            ctx.moveTo(0, 0);
            ctx.lineTo(width * 0.4, 0);
            ctx.lineTo(width * 0.2, height * 0.3);
            ctx.lineTo(0, height * 0.15);
            ctx.closePath();
            ctx.fill();
            
            // Bentuk diagonal kedua (sisi kanan)
            ctx.beginPath();
            ctx.moveTo(width, 0);
            ctx.lineTo(width * 0.6, 0);
            ctx.lineTo(width * 0.8, height * 0.3);
            ctx.lineTo(width, height * 0.15);
            ctx.closePath();
            ctx.fill();
            
            // Gambar bentuk persegi panjang (seperti struktur toko)
            ctx.fillStyle = '#FFFFFF';
            ctx.globalAlpha = 0.15;
            for (let i = 0; i < 5; i++) {
                const rectWidth = width * 0.1;
                const rectHeight = height * 0.05;
                const x = (width * 0.2) + (i * width * 0.15);
                const y = height * 0.8;
                ctx.fillRect(x, y, rectWidth, rectHeight);
            }
            
            // Gambar garis-garis vertikal (seperti pilar atau struktur)
            ctx.strokeStyle = '#FFFFFF';
            ctx.globalAlpha = 0.2;
            ctx.lineWidth = 3;
            for (let i = 1; i <= 4; i++) {
                const x = (width / 5) * i;
                ctx.beginPath();
                ctx.moveTo(x, height * 0.3);
                ctx.lineTo(x, height);
                ctx.stroke();
            }
            
            // Tambahkan efek lingkaran (seperti logo atau elemen dekoratif)
            ctx.fillStyle = '#FF6B35';
            ctx.globalAlpha = 0.1;
            
            // Lingkaran besar di kiri atas
            ctx.beginPath();
            ctx.arc(width * 0.15, height * 0.25, width * 0.08, 0, Math.PI * 2);
            ctx.fill();
            
            // Lingkaran besar di kanan atas
            ctx.beginPath();
            ctx.arc(width * 0.85, height * 0.25, width * 0.08, 0, Math.PI * 2);
            ctx.fill();
            
            // Lingkaran kecil di tengah bawah
            ctx.globalAlpha = 0.15;
            ctx.beginPath();
            ctx.arc(width * 0.5, height * 0.85, width * 0.05, 0, Math.PI * 2);
            ctx.fill();
            
            // Restore context state
            ctx.restore();
        }
        
        async function createComparisonImage(storeName, contohFile, realisasiFile) {
            try {
                // Load template dan kedua gambar user secara bersamaan
                const [templateImg, contohImg, realisasiImg] = await Promise.all([
                    loadTemplateImage('IMG-20250918-WA0268.jpg'), // Template eksternal
                    loadUserImage(contohFile),
                    loadUserImage(realisasiFile)
                ]);

                // Gunakan ukuran template sebagai dasar canvas
                const canvas = document.createElement('canvas');
                const ctx = canvas.getContext('2d');
                canvas.width = templateImg.width;
                canvas.height = templateImg.height;
                
                // 1. Gambar template sebagai background
                ctx.drawImage(templateImg, 0, 0);

                // 2. Tulis nama toko di area header putih
                // (Sesuaikan koordinat berdasarkan template xxx.jpg)
                const headerX = canvas.width * 0.05;
                const headerY = canvas.height * 0.05;
                const headerWidth = canvas.width * 0.9;
                const headerHeight = canvas.height * 0.12;
                
                // Bersihkan area header dan gambar ulang background putih
                ctx.fillStyle = 'white';
                ctx.fillRect(headerX, headerY, headerWidth, headerHeight);
                ctx.strokeStyle = '#333333';
                ctx.lineWidth = 2;
                ctx.strokeRect(headerX, headerY, headerWidth, headerHeight);

                // Tulis nama toko
                ctx.fillStyle = 'black';
                const fontSize = Math.floor(canvas.height * 0.04);
                ctx.font = `bold ${fontSize}px Arial`;
                ctx.textAlign = 'left';
                const textX = headerX + (canvas.width * 0.02);
                const textY = headerY + (headerHeight * 0.65);
                ctx.fillText(`INDOMARET: ${storeName.toUpperCase()}`, textX, textY);

                // 3. Gambar foto di area yang sudah disediakan template
                // Area foto (sesuaikan dengan layout template xxx.jpg)
                const mainAreaX = canvas.width * 0.05;
                const mainAreaY = canvas.height * 0.22;
                const mainAreaWidth = canvas.width * 0.9;
                const mainAreaHeight = canvas.height * 0.73;
                
                // Area foto individual (dikurangi margin dan space untuk label)
                const photoMargin = 10;
                const labelSpace = 50; // Space untuk label CONTOH/REALISASI
                const photoWidth = (mainAreaWidth / 2) - (photoMargin * 2);
                const photoHeight = mainAreaHeight - labelSpace - (photoMargin * 2);
                const photoY = mainAreaY + labelSpace + photoMargin;
                
                // Posisi foto contoh (kiri)
                const contohX = mainAreaX + photoMargin;
                ctx.drawImage(contohImg, contohX, photoY, photoWidth, photoHeight);
                
                // Posisi foto realisasi (kanan)
                const realisasiX = mainAreaX + (mainAreaWidth / 2) + photoMargin;
                ctx.drawImage(realisasiImg, realisasiX, photoY, photoWidth, photoHeight);
                
                return canvas;
                
            } catch (error) {
                console.error('Error in createComparisonImage:', error);
                throw new Error(`Gagal membuat gambar: ${error.message}`);
            }
        }

        function displayResult(canvas, cardNumber, storeName) {
            const results = document.getElementById('results');
            const resultCard = document.createElement('div');
            resultCard.className = 'result-card';
            resultCard.innerHTML = `
                <h3>Hasil Foto ${cardNumber} - ${storeName}</h3>
                <canvas class="result-canvas" id="result-canvas-${cardNumber}"></canvas>
                <div>
                    <button class="download-button" onclick="downloadImage(${cardNumber}, '${storeName}')">
                        üì• Download Foto ${cardNumber}
                    </button>
                </div>
            `;
            results.appendChild(resultCard);
            
            // Copy canvas ke result canvas
            const resultCanvas = document.getElementById(`result-canvas-${cardNumber}`);
            resultCanvas.width = canvas.width;
            resultCanvas.height = canvas.height;
            const resultCtx = resultCanvas.getContext('2d');
            resultCtx.drawImage(canvas, 0, 0);
        }

        function displayErrorResult(cardNumber, storeName, errorMessage) {
            const results = document.getElementById('results');
            const errorCard = document.createElement('div');
            errorCard.className = 'result-card';
            errorCard.style.border = '2px solid #dc3545';
            errorCard.innerHTML = `
                <h3 style="color: #dc3545;">‚ùå Error - Foto ${cardNumber} - ${storeName}</h3>
                <div style="padding: 20px; background: #f8f9fa; border-radius: 8px; margin: 15px 0;">
                    <p style="color: #dc3545; margin: 0;">
                        <strong>Gagal memproses foto:</strong><br>
                        ${errorMessage}
                    </p>
                    <p style="color: #666; margin-top: 10px; font-size: 14px;">
                        Pastikan file foto valid dan coba upload ulang.
                    </p>
                </div>
            `;
            results.appendChild(errorCard);
        }

        function downloadImage(cardNumber, storeName) {
            try {
                const canvas = processedCanvases.get(cardNumber);
                if (!canvas) {
                    alert(`Foto ${cardNumber} belum diproses atau terjadi error!`);
                    return;
                }
                
                // Konversi canvas ke blob untuk download yang lebih reliable
                canvas.toBlob(function(blob) {
                    const url = URL.createObjectURL(blob);
                    const link = document.createElement('a');
                    link.download = `INDOMARET_${storeName.replace(/\s+/g, '_')}_${cardNumber}.png`;
                    link.href = url;
                    document.body.appendChild(link);
                    link.click();
                    document.body.removeChild(link);
                    URL.revokeObjectURL(url);
                }, 'image/png', 1.0);
                
            } catch (error) {
                console.error('Download error:', error);
                alert('Gagal mendownload gambar! Silakan coba lagi.');
            }
        }

        // Initialize
        generateCards();
        
        document.getElementById('global-store-name').addEventListener('input', function() {
            const preview = document.getElementById('store-preview');
            preview.textContent = this.value.trim().toUpperCase() || 'NAMA TOKO ANDA';
        });

        // Cleanup saat halaman ditutup
        window.addEventListener('beforeunload', function() {
            processedCanvases.clear();
        });
    </script>
</body>
</html>
