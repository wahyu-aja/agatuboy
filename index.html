<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Kalkulator Antivarian</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Arial', sans-serif;
        }

        body {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            overflow-x: hidden;
        }

        .container {
            flex: 1;
            padding: 10px;
            max-width: 100vw;
        }

        .header {
            text-align: center;
            color: white;
            margin-bottom: 15px;
        }

        .header h1 {
            font-size: 1.8em;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.5);
        }

        .room-selection {
            background: rgba(255,255,255,0.95);
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 15px;
            box-shadow: 0 8px 32px rgba(0,0,0,0.1);
        }

        .room-buttons {
            display: grid;
            grid-template-columns: repeat(10, 1fr);
            gap: 8px;
            margin-bottom: 15px;
            max-height: 300px;
            overflow-y: auto;
        }

        .room-btn {
            padding: 10px 5px;
            border: none;
            border-radius: 8px;
            background: linear-gradient(45deg, #4CAF50, #45a049);
            color: white;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s;
            position: relative;
            font-size: 12px;
            min-height: 50px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
        }

        .room-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
        }

        .room-btn.occupied {
            background: linear-gradient(45deg, #ff9800, #f57c00);
        }

        .room-btn.active {
            background: linear-gradient(45deg, #2196F3, #1976D2);
        }

        .user-count {
            position: absolute;
            top: -8px;
            right: -8px;
            background: #f44336;
            color: white;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            font-size: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .calculator {
            background: rgba(255,255,255,0.95);
            border-radius: 15px;
            padding: 15px;
            box-shadow: 0 8px 32px rgba(0,0,0,0.1);
            display: none;
        }

        .calculator.active {
            display: block;
        }

        .status-bar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            padding: 10px;
            background: #f5f5f5;
            border-radius: 8px;
            font-size: 14px;
        }

        .display {
            text-align: center;
            font-size: 3em;
            font-weight: bold;
            color: #333;
            margin: 20px 0;
            min-height: 80px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: #f8f9fa;
            border-radius: 10px;
            border: 2px solid #e9ecef;
        }

        .button-grid {
            display: grid;
            gap: 8px;
            margin-bottom: 15px;
        }

        .add-buttons, .sub-buttons {
            display: grid;
            grid-template-columns: repeat(5, 1fr);
            gap: 8px;
            margin-bottom: 10px;
        }

        .btn {
            padding: 15px;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.2s;
        }

        .btn:active {
            transform: scale(0.95);
        }

        .add-btn {
            background: linear-gradient(45deg, #4CAF50, #45a049);
            color: white;
        }

        .sub-btn {
            background: linear-gradient(45deg, #f44336, #d32f2f);
            color: white;
        }

        .control-buttons {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            gap: 8px;
            margin-bottom: 15px;
        }

        .reset-btn {
            background: linear-gradient(45deg, #ff9800, #f57c00);
            color: white;
        }

        .finish-btn {
            background: linear-gradient(45deg, #9c27b0, #7b1fa2);
            color: white;
        }

        .leave-btn {
            background: linear-gradient(45deg, #607d8b, #455a64);
            color: white;
        }

        .history {
            max-height: 150px;
            overflow-y: auto;
            background: #f8f9fa;
            border-radius: 8px;
            padding: 10px;
            margin-bottom: 10px;
        }

        .history-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 5px;
            margin: 2px 0;
            background: white;
            border-radius: 4px;
            font-size: 14px;
        }

        .delete-btn {
            background: #f44336;
            color: white;
            border: none;
            border-radius: 3px;
            padding: 2px 6px;
            cursor: pointer;
            font-size: 12px;
        }

        .modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.7);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
        }

        .modal-content {
            background: white;
            padding: 30px;
            border-radius: 15px;
            text-align: center;
            max-width: 90%;
            box-shadow: 0 10px 40px rgba(0,0,0,0.3);
        }

        .modal-buttons {
            margin-top: 20px;
        }

        .modal-btn {
            padding: 10px 20px;
            margin: 0 5px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-weight: bold;
        }

        .approve-btn {
            background: #4CAF50;
            color: white;
        }

        .reject-btn {
            background: #f44336;
            color: white;
        }

        .captcha-input {
            padding: 10px;
            border: 2px solid #ddd;
            border-radius: 5px;
            font-size: 16px;
            margin: 10px 0;
            text-align: center;
        }

        .captcha-display {
            font-size: 24px;
            font-weight: bold;
            background: #f0f0f0;
            padding: 15px;
            border-radius: 5px;
            margin: 10px 0;
            letter-spacing: 3px;
        }

        .stats {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            font-size: 14px;
            color: #666;
        }

        .warning-text {
            text-align: center;
            background: rgba(255, 193, 7, 0.9);
            color: #333;
            padding: 15px;
            border-radius: 10px;
            margin: 15px 0;
            font-weight: bold;
            font-size: 16px;
            border: 2px solid #ffc107;
            box-shadow: 0 4px 12px rgba(255, 193, 7, 0.3);
        }

        .warning-text .warning-emoji {
            font-size: 24px;
            margin-right: 8px;
        }

        .admin-panel {
            position: fixed;
            bottom: 10px;
            right: 10px;
            width: 200px;
            background: rgba(0,0,0,0.8);
            color: white;
            border-radius: 8px;
            padding: 10px;
            font-size: 12px;
            display: none;
            z-index: 999;
        }

        .admin-panel.show {
            display: block;
        }

        .admin-panel input {
            width: 100%;
            padding: 5px;
            margin: 5px 0;
            border: 1px solid #444;
            background: #333;
            color: white;
            border-radius: 3px;
            font-size: 12px;
        }

        .admin-panel button {
            width: 100%;
            padding: 5px;
            margin: 2px 0;
            background: #dc3545;
            color: white;
            border: none;
            border-radius: 3px;
            cursor: pointer;
            font-size: 11px;
        }

        .admin-panel button:hover {
            background: #c82333;
        }

        .admin-toggle {
            position: fixed;
            bottom: 10px;
            right: 10px;
            width: 30px;
            height: 30px;
            background: rgba(0,0,0,0.3);
            border: none;
            border-radius: 50%;
            cursor: pointer;
            font-size: 16px;
            z-index: 998;
        }

        .whitelist-status {
            font-size: 11px;
            color: #28a745;
            margin-top: 5px;
        }

        .connection-status {
            text-align: center;
            padding: 10px;
            margin-bottom: 15px;
            border-radius: 8px;
            font-weight: bold;
        }

        .connection-status.connected {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .connection-status.disconnected {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        @media (max-width: 480px) {
            .container {
                padding: 5px;
            }
            
            .display {
                font-size: 2.5em;
                min-height: 60px;
            }
            
            .btn {
                padding: 12px;
                font-size: 14px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>🧮 Kalkulator Antivarian</h1>
            <p>Multi-User Real-time Calculator</p>
        </div>

        <div id="connectionStatus" class="connection-status disconnected">
            🔴 Menghubungkan ke database...
        </div>

        <div class="room-selection" id="roomSelection">
            <h3>Pilih Kamar Sesi (1-50):</h3>
            <div class="room-buttons" id="roomButtons">
                <!-- Room buttons will be generated by JavaScript -->
            </div>
        </div>

        <div class="calculator" id="calculator">
            <div class="status-bar">
                <div id="userRole">Status: Menunggu...</div>
                <div id="roomInfo">Kamar: -</div>
                <div id="userCount">Users: 0</div>
            </div>

            <div class="display" id="display">0</div>

            <div class="button-grid">
                <div class="add-buttons">
                    <button class="btn add-btn" onclick="addValue(100)">+100</button>
                    <button class="btn add-btn" onclick="addValue(200)">+200</button>
                    <button class="btn add-btn" onclick="addValue(300)">+300</button>
                    <button class="btn add-btn" onclick="addValue(400)">+400</button>
                    <button class="btn add-btn" onclick="addValue(500)">+500</button>
                </div>
                
                <div class="sub-buttons">
                    <button class="btn sub-btn" onclick="addValue(-100)">-100</button>
                    <button class="btn sub-btn" onclick="addValue(-200)">-200</button>
                    <button class="btn sub-btn" onclick="addValue(-300)">-300</button>
                    <button class="btn sub-btn" onclick="addValue(-400)">-400</button>
                    <button class="btn sub-btn" onclick="addValue(-500)">-500</button>
                </div>
            </div>

            <div class="control-buttons">
                <button class="btn reset-btn" onclick="showResetWarning()">Reset</button>
                <button class="btn finish-btn" onclick="showFinishModal()">Selesai</button>
            </div>

            <div class="stats">
                <div>Total Tekan: <span id="clickCount">0</span></div>
                <div>Sesi Aktif: <span id="sessionTime">00:00</span></div>
            </div>

            <div class="history" id="history">
                <strong>History:</strong>
                <div id="historyList"></div>
            </div>

            <!-- Warning message added here -->
            <div class="warning-text">
                <span class="warning-emoji">⚠️</span>INGAT MODAL KAWAN
            </div>
        </div>
    </div>

    <!-- Admin Panel Toggle -->
    <button class="admin-toggle" onclick="toggleAdminPanel()">⚙</button>

    <!-- Admin Panel -->
    <div class="admin-panel" id="adminPanel">
        <strong>Admin Panel</strong>
        <input type="text" id="adminUser" placeholder="Username" value="">
        <input type="password" id="adminPass" placeholder="Password" value="">
        <button onclick="adminLogin()">Login</button>
        <div id="adminControls" style="display: none;">
            <button onclick="resetAllRooms()">Reset All Rooms</button>
            <button onclick="clearAllUsers()">Clear All Users</button>
            <button onclick="adminLogout()">Logout</button>
            <div class="whitelist-status" id="whitelistStatus"></div>
        </div>
    </div>

    <!-- Modal login nama -->
    <div class="modal" id="nameModal" style="display: none;">
        <div class="modal-content">
            <h3>Selamat Datang!</h3>
            <p>Masukkan nama Anda untuk melanjutkan:</p>
            <input type="text" id="nameInput" class="captcha-input" placeholder="Masukkan nama Anda" maxlength="20">
            <div class="modal-buttons">
                <button class="modal-btn approve-btn" onclick="saveName()">Lanjutkan</button>
            </div>
            <p style="font-size: 12px; color: #666; margin-top: 10px;">
                Nama akan disimpan untuk login otomatis di masa depan
            </p>
        </div>
    </div>

    <!-- Modal untuk warning reset -->
    <div class="modal" id="resetWarningModal" style="display: none;">
        <div class="modal-content">
            <h3>⚠️ Peringatan Reset</h3>
            <p style="color: #d32f2f; font-weight: bold; margin: 15px 0;">
                Anda akan mereset nilai kalkulator ke 0!<br>
                Semua progress akan hilang.
            </p>
            <p>Apakah Anda yakin ingin melanjutkan?</p>
            <div class="modal-buttons">
                <button class="modal-btn approve-btn" onclick="confirmReset()">Setuju</button>
                <button class="modal-btn reject-btn" onclick="hideResetWarning()">Batal</button>
            </div>
        </div>
    </div>

    <!-- Modal untuk persetujuan admin -->
    <div class="modal" id="approvalModal" style="display: none;">
        <div class="modal-content">
            <h3>Permintaan Bergabung</h3>
            <p id="approvalMessage">User baru ingin bergabung ke kamar ini.</p>
            <div class="modal-buttons">
                <button class="modal-btn approve-btn" onclick="approveUser(true)">Setuju</button>
                <button class="modal-btn reject-btn" onclick="approveUser(false)">Tolak</button>
            </div>
        </div>
    </div>

    <!-- Modal untuk menunggu persetujuan -->
    <div class="modal" id="waitingModal" style="display: none;">
        <div class="modal-content">
            <h3>Menunggu Persetujuan</h3>
            <p>Admin sedang mempertimbangkan permintaan Anda untuk bergabung.</p>
            <button class="modal-btn reject-btn" onclick="cancelJoin()">Batal</button>
        </div>
    </div>

    <!-- Modal untuk menyelesaikan sesi -->
    <div class="modal" id="finishModal" style="display: none;">
        <div class="modal-content">
            <h3>Selesaikan Sesi</h3>
            <p>Masukkan kode CAPTCHA untuk menyelesaikan sesi:</p>
            <div class="captcha-display" id="captchaDisplay"></div>
            <input type="text" class="captcha-input" id="captchaInput" placeholder="Masukkan kode">
            <div class="modal-buttons">
                <button class="modal-btn approve-btn" onclick="finishSession()">Selesai</button>
                <button class="modal-btn reject-btn" onclick="hideFinishModal()">Batal</button>
            </div>
        </div>
    </div>

    <!-- Modal notifikasi -->
    <div class="modal" id="notificationModal" style="display: none;">
        <div class="modal-content">
            <h3 id="notificationTitle">Notifikasi</h3>
            <p id="notificationMessage"></p>
            <button class="modal-btn approve-btn" onclick="hideNotification()">OK</button>
        </div>
    </div>

    <!-- Firebase SDK v8 (Compatible) -->
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>

    <script>
        // Global variables
        let database;
        let currentUserData = getUserId();
        let gameState = {
            currentRoom: null,
            currentUser: currentUserData?.id || null,
            userName: currentUserData?.name || null,
            isAdmin: false,
            pendingApproval: null,
            currentPendingUser: null,
            isWhitelisted: false // Track if user is whitelisted
        };

        let adminLoggedIn = false;
        const ADMIN_CREDENTIALS = {
            username: 'wahyu',
            password: '123'
        };

        // Generate or retrieve persistent user data
        function getUserId() {
            let userData = localStorage.getItem('calculatorUserData');
            if (userData) {
                return JSON.parse(userData);
            }
            return null;
        }

        function saveUserData(name) {
            const userData = {
                id: 'user_' + Math.random().toString(36).substring(7) + '_' + Date.now(),
                name: name,
                created: Date.now()
            };
            localStorage.setItem('calculatorUserData', JSON.stringify(userData));
            return userData;
        }

        // Clear user session (for testing purposes)
        function clearUserSession() {
            localStorage.removeItem('calculatorUserData');
            location.reload();
        }

        let sessionTimer = null;
        let roomListeners = {};

        // KONFIGURASI FIREBASE
        const firebaseConfig = {
            apiKey: "AIzaSyAa2eES4WwUxpttkVOgvwUd9EK3iCqR6Ao",
            authDomain: "kalkulator2803.firebaseapp.com",
            databaseURL: "https://kalkulator2803-default-rtdb.asia-southeast1.firebasedatabase.app",
            projectId: "kalkulator2803",
            storageBucket: "kalkulator2803.firebasestorage.app",
            messagingSenderId: "608669212250",
            appId: "1:608669212250:web:3c20bc28c7df5bed1c4263",
            measurementId: "G-XX80E4Z2VX"
        };

        // Initialize Firebase function - FIXED
        function initializeFirebase() {
            try {
                console.log('🚀 Menginisialisasi Firebase...');
                
                if (!firebase.apps.length) {
                    firebase.initializeApp(firebaseConfig);
                }
                
                database = firebase.database();
                console.log('✅ Firebase berhasil terhubung');
                
                // Test database connection
                database.ref('.info/connected').on('value', (snapshot) => {
                    const connected = snapshot.val();
                    updateConnectionStatus(connected);
                    
                    if (connected) {
                        console.log('🟢 Database terhubung');
                        generateRoomButtons();
                        initializeRooms();
                        listenToAllRooms();
                    } else {
                        console.log('🔴 Database tidak terhubung');
                    }
                });
                
            } catch (error) {
                console.error('❌ Firebase gagal terhubung:', error);
                updateConnectionStatus(false);
                showNotification('Error Koneksi', 'Gagal terhubung ke Firebase: ' + error.message);
            }
        }

        // Generate room buttons dynamically
        function generateRoomButtons() {
            const roomButtonsContainer = document.getElementById('roomButtons');
            if (!roomButtonsContainer) return;
            
            roomButtonsContainer.innerHTML = '';
            
            for (let i = 1; i <= 50; i++) {
                const button = document.createElement('button');
                button.className = 'room-btn';
                button.onclick = () => joinRoom(i);
                button.innerHTML = `
                    Room ${i}
                    <span class="user-count" id="count${i}">0</span>
                `;
                roomButtonsContainer.appendChild(button);
            }
        }

        // Update connection status display
        function updateConnectionStatus(connected) {
            const statusEl = document.getElementById('connectionStatus');
            if (connected) {
                statusEl.className = 'connection-status connected';
                statusEl.innerHTML = '🟢 Database terhubung';
            } else {
                statusEl.className = 'connection-status disconnected';
                statusEl.innerHTML = '🔴 Database tidak terhubung - periksa rules Firebase';
            }
        }

        // Initialize
        document.addEventListener('DOMContentLoaded', function() {
            console.log('🚀 Aplikasi dimulai...');
            
            // Check if user has saved name
            if (!gameState.userName) {
                console.log('👤 User belum input nama, tampilkan modal');
                showNameModal();
                return;
            }
            
            console.log('👤 User:', gameState.userName, 'ID:', gameState.currentUser);
            
            // Test koneksi Firebase
            if (typeof firebase === 'undefined') {
                console.error('❌ Firebase SDK tidak termuat');
                updateConnectionStatus(false);
                showNotification('Error', 'Firebase SDK tidak termuat. Pastikan koneksi internet Anda stabil.');
                return;
            }
            
            // Initialize Firebase
            initializeFirebase();
        });

        // Firebase functions
        function initializeRooms() {
            console.log('🔄 Menginisialisasi rooms...');
            
            if (!database) {
                console.error('❌ Database tidak tersedia');
                return;
            }
            
            // Initialize rooms in Firebase if they don't exist
            for (let i = 1; i <= 5; i++) {
                database.ref(`rooms/${i}`).once('value', (snapshot) => {
                    if (!snapshot.exists()) {
                        console.log(`📝 Membuat room ${i}...`);
                        database.ref(`rooms/${i}`).set({
                            value: 0,
                            users: {},
                            admin: null,
                            history: {},
                            clickCount: 0,
                            startTime: null,
                            active: false,
                            pendingUsers: {}
                        }).then(() => {
                            console.log(`✅ Room ${i} berhasil dibuat`);
                        }).catch((error) => {
                            console.error(`❌ Gagal membuat room ${i}:`, error);
                        });
                    } else {
                        console.log(`✅ Room ${i} sudah ada`);
                    }
                }).catch((error) => {
                    console.error(`❌ Gagal mengecek room ${i}:`, error);
                });
            }
        }

        function listenToAllRooms() {
            if (!database) return;
            
            // Listen to all rooms for user count updates
            for (let i = 1; i <= 5; i++) {
                // Listen to all rooms for user count updates
                database.ref(`rooms/${i}/users`).on('value', (snapshot) => {
                    const users = snapshot.val() || {};
                    const userCount = Object.keys(users).length;
                    const countEl = document.getElementById(`count${i}`);
                    if (countEl) {
                        countEl.textContent = userCount;
                    }
                    
                    const btn = document.querySelector(`.room-buttons .room-btn:nth-child(${i})`);
                    if (btn) {
                        // Check if current user is in this room
                        const isUserInRoom = users.hasOwnProperty(gameState.currentUser);
                        const isUserAdmin = users[gameState.currentUser]?.isAdmin;
                        
                        if (userCount === 0) {
                            btn.className = 'room-btn';
                        } else if (isUserInRoom) {
                            btn.className = 'room-btn active';
                            // Auto-rejoin if user was in room before refresh
                            if (!gameState.currentRoom) {
                                console.log(`🔄 Auto-rejoining room ${i} as ${isUserAdmin ? 'admin' : 'user'}`);
                                gameState.currentRoom = i;
                                gameState.isAdmin = isUserAdmin;
                                listenToRoom(i);
                                showCalculator();
                                if (isUserAdmin) {
                                    startSessionTimer();
                                }
                            }
                        } else {
                            btn.className = 'room-btn occupied';
                        }
                    }
                }, (error) => {
                    console.error(`❌ Error listening to room ${i}:`, error);
                });
            }
        }

        function listenToRoom(roomId) {
            if (!database) return;
            
            // Listen to specific room changes
            const roomRef = database.ref(`rooms/${roomId}`);
            
            roomListeners[roomId] = roomRef.on('value', (snapshot) => {
                const roomData = snapshot.val();
                if (roomData && gameState.currentRoom === roomId) {
                    updateDisplayFromFirebase(roomData);
                    updateHistoryFromFirebase(roomData.history || {});
                    checkAdminRequests(roomData);
                }
            }, (error) => {
                console.error(`❌ Error listening to room ${roomId}:`, error);
            });
        }

        function stopListeningToRoom(roomId) {
            if (roomListeners[roomId] && database) {
                database.ref(`rooms/${roomId}`).off('value', roomListeners[roomId]);
                delete roomListeners[roomId];
            }
        }

        // Room management
        function joinRoom(roomId) {
            console.log(`🚪 Mencoba masuk ke room ${roomId}...`);
            
            if (!database) {
                console.error('❌ Database tidak tersedia');
                showNotification('Error', 'Database tidak terhubung. Silakan periksa koneksi.');
                return;
            }
            
            // Check if user is already in this room
            database.ref(`rooms/${roomId}/users/${gameState.currentUser}`).once('value', (userSnapshot) => {
                if (userSnapshot.exists()) {
                    // User already in room, rejoin directly
                    const userData = userSnapshot.val();
                    console.log(`🔄 Rejoining room ${roomId} as existing user`);
                    
                    gameState.currentRoom = roomId;
                    gameState.isAdmin = userData.isAdmin;
                    
                    // Update join time
                    database.ref(`rooms/${roomId}/users/${gameState.currentUser}/lastSeen`).set(Date.now());
                    
                    listenToRoom(roomId);
                    showCalculator();
                    if (gameState.isAdmin) {
                        startSessionTimer();
                    }
                    return;
                }
                
                // User not in room, proceed with normal join logic
                database.ref(`rooms/${roomId}`).once('value', (snapshot) => {
                    console.log(`📊 Data room ${roomId}:`, snapshot.val());
                    
                    const roomData = snapshot.val();
                    if (!roomData) {
                        console.error(`❌ Room ${roomId} tidak ditemukan`);
                        showNotification('Error', `Room ${roomId} tidak ditemukan. Silakan refresh halaman.`);
                        return;
                    }
                    
                    const users = roomData.users || {};
                    const userCount = Object.keys(users).length;
                    console.log(`👥 Jumlah user di room ${roomId}: ${userCount}`);
                    
                    if (userCount === 0) {
                        console.log(`👑 Menjadi admin room ${roomId}`);
                        // User pertama jadi admin
                        const updates = {};
                        updates[`rooms/${roomId}/admin`] = gameState.currentUser;
                        updates[`rooms/${roomId}/users/${gameState.currentUser}`] = {
                            joinTime: Date.now(),
                            lastSeen: Date.now(),
                            isAdmin: true,
                            name: gameState.userName
                        };
                        updates[`rooms/${roomId}/startTime`] = Date.now();
                        updates[`rooms/${roomId}/active`] = true;
                        
                        database.ref().update(updates).then(() => {
                            console.log('✅ Berhasil menjadi admin');
                            gameState.isAdmin = true;
                            gameState.currentRoom = roomId;
                            listenToRoom(roomId);
                            showNotification('Selamat!', 'Anda adalah admin untuk kamar ini!');
                            showCalculator();
                            startSessionTimer();
                        }).catch((error) => {
                            console.error('❌ Gagal menjadi admin:', error);
                            showNotification('Error', 'Gagal bergabung sebagai admin: ' + error.message);
                        });
                    } else {
                        console.log(`⏳ Cek whitelist dan meminta persetujuan admin room ${roomId}`);
                        
                        // Check if user is whitelisted in this room
                        database.ref(`rooms/${roomId}/whitelist/${gameState.currentUser}`).once('value', (whitelistSnapshot) => {
                            if (whitelistSnapshot.exists()) {
                                // User is whitelisted, join directly
                                console.log('✅ User whitelisted, join langsung');
                                const updates = {};
                                updates[`rooms/${roomId}/users/${gameState.currentUser}`] = {
                                    joinTime: Date.now(),
                                    lastSeen: Date.now(),
                                    isAdmin: false,
                                    name: gameState.userName
                                };
                                
                                database.ref().update(updates).then(() => {
                                    gameState.currentRoom = roomId;
                                    gameState.isAdmin = false;
                                    gameState.isWhitelisted = true;
                                    listenToRoom(roomId);
                                    showCalculator();
                                    showNotification('Selamat!', 'Anda sudah terdaftar di kamar ini!');
                                }).catch((error) => {
                                    console.error('❌ Gagal join sebagai whitelisted user:', error);
                                    showNotification('Error', 'Gagal bergabung: ' + error.message);
                                });
                            } else {
                                // Perlu persetujuan admin
                                gameState.pendingApproval = roomId;
                                
                                // Tambahkan ke pending approvals dengan nama
                                database.ref(`rooms/${roomId}/pendingUsers/${gameState.currentUser}`).set({
                                    requestTime: Date.now(),
                                    status: 'waiting',
                                    name: gameState.userName
                                }).then(() => {
                                    console.log('✅ Permintaan approval terkirim');
                                    showWaitingModal();
                                    listenForApproval(roomId);
                                }).catch((error) => {
                                    console.error('❌ Gagal mengirim permintaan:', error);
                                    showNotification('Error', 'Gagal mengirim permintaan: ' + error.message);
                                });
                            }
                        }).catch((error) => {
                            console.error('❌ Gagal cek whitelist:', error);
                            showNotification('Error', 'Gagal mengecek status: ' + error.message);
                        });
                    }
                }).catch((error) => {
                    console.error(`❌ Gagal mengakses room ${roomId}:`, error);
                    showNotification('Error', 'Gagal mengakses room: ' + error.message);
                });
            }).catch((error) => {
                console.error('❌ Gagal cek user existence:', error);
                showNotification('Error', 'Gagal mengecek status user: ' + error.message);
            });
        }

        function listenForApproval(roomId) {
            if (!database) return;
            
            const approvalRef = database.ref(`rooms/${roomId}/pendingUsers/${gameState.currentUser}/status`);
            
            approvalRef.on('value', (snapshot) => {
                const status = snapshot.val();
                
                if (status === 'approved') {
                    // Add user to room
                    database.ref(`rooms/${roomId}/users/${gameState.currentUser}`).set({
                        joinTime: Date.now(),
                        lastSeen: Date.now(),
                        isAdmin: false,
                        name: gameState.userName
                    });
                    
                    // Add to whitelist for future auto-join
                    database.ref(`rooms/${roomId}/whitelist/${gameState.currentUser}`).set({
                        name: gameState.userName,
                        approvedTime: Date.now(),
                        approvedBy: roomData?.admin || 'unknown'
                    });
                    
                    // Remove from pending
                    database.ref(`rooms/${roomId}/pendingUsers/${gameState.currentUser}`).remove();
                    
                    gameState.currentRoom = roomId;
                    gameState.isAdmin = false;
                    gameState.isWhitelisted = true;
                    gameState.pendingApproval = null;
                    
                    hideWaitingModal();
                    listenToRoom(roomId);
                    showCalculator();
                    startSessionTimer();
                    
                    approvalRef.off();
                } else if (status === 'rejected') {
                    database.ref(`rooms/${roomId}/pendingUsers/${gameState.currentUser}`).remove();
                    
                    gameState.pendingApproval = null;
                    hideWaitingModal();
                    showNotification('Ditolak', 'Admin menolak permintaan Anda untuk bergabung.');
                    
                    approvalRef.off();
                }
            });
        }

        function leaveRoom() {
            if (gameState.currentRoom && database) {
                const roomId = gameState.currentRoom;
                
                // Remove user from room
                database.ref(`rooms/${roomId}/users/${gameState.currentUser}`).remove();
                
                // Jika admin keluar, reset room
                if (gameState.isAdmin) {
                    database.ref(`rooms/${roomId}`).set({
                        value: 0,
                        users: {},
                        admin: null,
                        history: {},
                        clickCount: 0,
                        startTime: null,
                        active: false,
                        pendingUsers: {}
                    });
                }
                
                stopListeningToRoom(roomId);
                gameState.currentRoom = null;
                gameState.isAdmin = false;
                
                hideCalculator();
                stopSessionTimer();
            }
        }

        function checkAdminRequests(roomData) {
            if (gameState.isAdmin && roomData.pendingUsers) {
                const pending = Object.keys(roomData.pendingUsers).filter(
                    userId => roomData.pendingUsers[userId].status === 'waiting'
                );
                
                if (pending.length > 0) {
                    showApprovalModal(pending[0]);
                }
            }
        }

        // Calculator functions
        function addValue(amount) {
            if (!gameState.currentRoom || !database) return;
            
            const roomRef = database.ref(`rooms/${gameState.currentRoom}`);
            
            // Get current value and update
            roomRef.once('value', (snapshot) => {
                const roomData = snapshot.val();
                if (!roomData) return;
                
                const newValue = (roomData.value || 0) + amount;
                const newClickCount = (roomData.clickCount || 0) + 1;
                const historyId = Date.now().toString();
                
                const updates = {};
                updates[`rooms/${gameState.currentRoom}/value`] = newValue;
                updates[`rooms/${gameState.currentRoom}/clickCount`] = newClickCount;
                updates[`rooms/${gameState.currentRoom}/history/${historyId}`] = {
                    action: `${amount > 0 ? '+' : ''}${amount}`,
                    result: newValue,
                    user: gameState.currentUser,
                    timestamp: new Date().toLocaleTimeString()
                };
                
                database.ref().update(updates);
            });
        }

        // Modified reset function with warning
        function showResetWarning() {
            const modal = document.getElementById('resetWarningModal');
            if (modal) modal.style.display = 'flex';
        }

        function hideResetWarning() {
            const modal = document.getElementById('resetWarningModal');
            if (modal) modal.style.display = 'none';
        }

        function confirmReset() {
            hideResetWarning();
            resetValue();
        }

        function resetValue() {
            if (!gameState.currentRoom || !database) return;
            
            const historyId = Date.now().toString();
            const updates = {};
            updates[`rooms/${gameState.currentRoom}/value`] = 0;
            updates[`rooms/${gameState.currentRoom}/history/${historyId}`] = {
                action: 'RESET',
                result: 0,
                user: gameState.currentUser,
                timestamp: new Date().toLocaleTimeString()
            };
            
            database.ref().update(updates);
        }

        function deleteHistoryItem(id) {
            if (!gameState.currentRoom || !database) return;
            database.ref(`rooms/${gameState.currentRoom}/history/${id}`).remove();
        }

        // Display updates
        function updateDisplayFromFirebase(roomData) {
            const displayEl = document.getElementById('display');
            const clickCountEl = document.getElementById('clickCount');
            const userRoleEl = document.getElementById('userRole');
            const roomInfoEl = document.getElementById('roomInfo');
            const userCountEl = document.getElementById('userCount');
            
            if (displayEl) displayEl.textContent = (roomData.value || 0).toLocaleString();
            if (clickCountEl) clickCountEl.textContent = roomData.clickCount || 0;
            if (userRoleEl) userRoleEl.textContent = `${gameState.userName} (${gameState.isAdmin ? 'Admin' : 'User'})`;
            if (roomInfoEl) roomInfoEl.textContent = `Kamar: ${gameState.currentRoom}`;
            
            const users = roomData.users || {};
            if (userCountEl) userCountEl.textContent = `Users: ${Object.keys(users).length}`;
        }

        function updateHistoryFromFirebase(historyData) {
            const historyList = document.getElementById('historyList');
            if (!historyList) return;
            
            const historyArray = Object.keys(historyData).map(key => ({
                id: key,
                ...historyData[key]
            })).sort((a, b) => b.id - a.id).slice(0, 10);
            
            historyList.innerHTML = historyArray.map(item => `
                <div class="history-item">
                    <span>${item.timestamp} - ${item.action} = ${(item.result || 0).toLocaleString()}</span>
                    <button class="delete-btn" onclick="deleteHistoryItem('${item.id}')">×</button>
                </div>
            `).join('');
        }

        // Modal functions
        function showCalculator() {
            const roomSelection = document.getElementById('roomSelection');
            const calculator = document.getElementById('calculator');
            
            if (roomSelection) roomSelection.style.display = 'none';
            if (calculator) calculator.style.display = 'block';
        }

        function hideCalculator() {
            const roomSelection = document.getElementById('roomSelection');
            const calculator = document.getElementById('calculator');
            
            if (roomSelection) roomSelection.style.display = 'block';
            if (calculator) calculator.style.display = 'none';
        }

        function showWaitingModal() {
            const modal = document.getElementById('waitingModal');
            if (modal) modal.style.display = 'flex';
        }

        function hideWaitingModal() {
            const modal = document.getElementById('waitingModal');
            if (modal) modal.style.display = 'none';
        }

        function cancelJoin() {
            if (gameState.pendingApproval && database) {
                database.ref(`rooms/${gameState.pendingApproval}/pendingUsers/${gameState.currentUser}`).remove();
            }
            gameState.pendingApproval = null;
            hideWaitingModal();
        }

        function showFinishModal() {
            if (!gameState.isAdmin) {
                showNotification('Akses Ditolak', 'Hanya admin yang dapat menyelesaikan sesi.');
                return;
            }
            
            const captcha = generateCaptcha();
            const captchaDisplay = document.getElementById('captchaDisplay');
            const captchaInput = document.getElementById('captchaInput');
            const modal = document.getElementById('finishModal');
            
            if (captchaDisplay) captchaDisplay.textContent = captcha;
            if (captchaInput) captchaInput.value = '';
            if (modal) modal.style.display = 'flex';
        }

        function hideFinishModal() {
            const modal = document.getElementById('finishModal');
            if (modal) modal.style.display = 'none';
        }

        function generateCaptcha() {
            const chars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789';
            let result = '';
            for (let i = 0; i < 6; i++) {
                result += chars.charAt(Math.floor(Math.random() * chars.length));
            }
            return result;
        }

        function finishSession() {
            const captchaInput = document.getElementById('captchaInput');
            const captchaDisplay = document.getElementById('captchaDisplay');
            
            if (!captchaInput || !captchaDisplay) return;
            
            const inputCaptcha = captchaInput.value.toUpperCase();
            const displayCaptcha = captchaDisplay.textContent;
            
            if (inputCaptcha !== displayCaptcha) {
                showNotification('Error', 'Kode CAPTCHA salah!');
                return;
            }
            
            // Finish session - reset room in Firebase
            const roomId = gameState.currentRoom;
            if (roomId && database) {
                database.ref(`rooms/${roomId}`).set({
                    value: 0,
                    users: {},
                    admin: null,
                    history: {},
                    clickCount: 0,
                    startTime: null,
                    active: false,
                    pendingUsers: {}
                });
                
                stopListeningToRoom(roomId);
            }
            
            gameState.currentRoom = null;
            gameState.isAdmin = false;
            
            hideFinishModal();
            hideCalculator();
            stopSessionTimer();
            
            showNotification('Sesi Selesai', 'Sesi telah berakhir. Semua user telah dikeluarkan dari kamar.');
        }

        function showNotification(title, message) {
            const titleEl = document.getElementById('notificationTitle');
            const messageEl = document.getElementById('notificationMessage');
            const modal = document.getElementById('notificationModal');
            
            if (titleEl) titleEl.textContent = title;
            if (messageEl) messageEl.textContent = message;
            if (modal) modal.style.display = 'flex';
        }

        function hideNotification() {
            const modal = document.getElementById('notificationModal');
            if (modal) modal.style.display = 'none';
        }

        // Timer functions
        function startSessionTimer() {
            sessionTimer = setInterval(updateSessionTime, 1000);
        }

        function stopSessionTimer() {
            if (sessionTimer) {
                clearInterval(sessionTimer);
                sessionTimer = null;
            }
        }

        function updateSessionTime() {
            if (gameState.currentRoom && database) {
                database.ref(`rooms/${gameState.currentRoom}/startTime`).once('value', (snapshot) => {
                    const startTime = snapshot.val();
                    const sessionTimeEl = document.getElementById('sessionTime');
                    
                    if (startTime && sessionTimeEl) {
                        const elapsed = Math.floor((Date.now() - startTime) / 1000);
                        const minutes = Math.floor(elapsed / 60);
                        const seconds = elapsed % 60;
                        sessionTimeEl.textContent = 
                            `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
                    }
                });
            }
        }

        function showApprovalModal(pendingUserId) {
            // Get user data to show name
            if (gameState.currentRoom && database) {
                database.ref(`rooms/${gameState.currentRoom}/pendingUsers/${pendingUserId}`).once('value', (snapshot) => {
                    const pendingData = snapshot.val();
                    const messageEl = document.getElementById('approvalMessage');
                    const modal = document.getElementById('approvalModal');
                    
                    if (messageEl) {
                        messageEl.textContent = `${pendingData?.name || pendingUserId} ingin bergabung ke kamar ini.`;
                    }
                    if (modal) modal.style.display = 'flex';
                    
                    // Store pending user for approval
                    gameState.currentPendingUser = pendingUserId;
                });
            }
        }

        // Admin Panel Functions
        function toggleAdminPanel() {
            const panel = document.getElementById('adminPanel');
            if (panel) {
                panel.classList.toggle('show');
            }
        }

        function adminLogin() {
            const username = document.getElementById('adminUser').value;
            const password = document.getElementById('adminPass').value;
            
            if (username === ADMIN_CREDENTIALS.username && password === ADMIN_CREDENTIALS.password) {
                adminLoggedIn = true;
                document.getElementById('adminControls').style.display = 'block';
                showNotification('Admin Login', 'Login berhasil! Panel admin aktif.');
                updateWhitelistStatus();
            } else {
                showNotification('Login Gagal', 'Username atau password salah!');
            }
        }

        function adminLogout() {
            adminLoggedIn = false;
            document.getElementById('adminControls').style.display = 'none';
            document.getElementById('adminUser').value = '';
            document.getElementById('adminPass').value = '';
            const panel = document.getElementById('adminPanel');
            if (panel) panel.classList.remove('show');
            showNotification('Admin Logout', 'Logout berhasil!');
        }

        function resetAllRooms() {
            if (!adminLoggedIn) {
                showNotification('Akses Ditolak', 'Harus login sebagai admin!');
                return;
            }
            
            if (!confirm('Yakin ingin reset semua 50 room? Semua data akan hilang!')) {
                return;
            }
            
            if (!database) {
                showNotification('Error', 'Database tidak terhubung!');
                return;
            }
            
            console.log('🔄 Admin: Mereset semua 50 rooms...');
            
            for (let i = 1; i <= 50; i++) {
                database.ref(`rooms/${i}`).set({
                    value: 0,
                    users: {},
                    admin: null,
                    history: {},
                    clickCount: 0,
                    startTime: null,
                    active: false,
                    pendingUsers: {},
                    whitelist: {}
                });
            }
            
            // Reset current user state if in any room
            if (gameState.currentRoom) {
                gameState.currentRoom = null;
                gameState.isAdmin = false;
                gameState.isWhitelisted = false;
                hideCalculator();
                stopSessionTimer();
            }
            
            showNotification('Reset Berhasil', 'Semua 50 room telah direset!');
        }

        function clearAllUsers() {
            if (!adminLoggedIn) {
                showNotification('Akses Ditolak', 'Harus login sebagai admin!');
                return;
            }
            
            if (!confirm('Yakin ingin hapus semua data user? Data whitelist juga akan hilang!')) {
                return;
            }
            
            // Clear localStorage for all users (only affects current browser)
            localStorage.clear();
            
            showNotification('Clear Berhasil', 'Data user lokal telah dihapus. User lain perlu refresh untuk logout.');
        }

        function updateWhitelistStatus() {
            const statusEl = document.getElementById('whitelistStatus');
            if (statusEl && gameState.currentRoom) {
                if (gameState.isWhitelisted) {
                    statusEl.textContent = `✓ Whitelisted di Room ${gameState.currentRoom}`;
                } else if (gameState.isAdmin) {
                    statusEl.textContent = `👑 Admin di Room ${gameState.currentRoom}`;
                } else {
                    statusEl.textContent = `⏳ Belum whitelisted`;
                }
            }
        }
        // Name modal functions
        function showNameModal() {
            const modal = document.getElementById('nameModal');
            const input = document.getElementById('nameInput');
            if (modal) modal.style.display = 'flex';
            if (input) {
                input.focus();
                input.addEventListener('keypress', function(e) {
                    if (e.key === 'Enter') {
                        saveName();
                    }
                });
            }
        }

        function hideNameModal() {
            const modal = document.getElementById('nameModal');
            if (modal) modal.style.display = 'none';
        }

        function saveName() {
            const input = document.getElementById('nameInput');
            if (!input) return;
            
            const name = input.value.trim();
            if (!name) {
                showNotification('Error', 'Nama tidak boleh kosong!');
                return;
            }
            
            if (name.length < 2) {
                showNotification('Error', 'Nama minimal 2 karakter!');
                return;
            }
            
            // Save user data
            const userData = saveUserData(name);
            gameState.currentUser = userData.id;
            gameState.userName = userData.name;
            
            console.log('✅ User data saved:', userData);
            hideNameModal();
            
            // Initialize Firebase now
            if (typeof firebase !== 'undefined') {
                initializeFirebase();
            } else {
                showNotification('Error', 'Firebase SDK tidak termuat. Silakan refresh halaman.');
            }
        }

        function approveUser(approved) {
            if (!gameState.currentPendingUser || !database) return;
            
            const roomId = gameState.currentRoom;
            const userId = gameState.currentPendingUser;
            
            database.ref(`rooms/${roomId}/pendingUsers/${userId}/status`)
                .set(approved ? 'approved' : 'rejected');
            
            gameState.currentPendingUser = null;
            const modal = document.getElementById('approvalModal');
            if (modal) modal.style.display = 'none';
        }

        // Prevent zoom on double tap for better mobile experience
        let lastTouchEnd = 0;
        document.addEventListener('touchend', function (event) {
            const now = (new Date()).getTime();
            if (now - lastTouchEnd <= 300) {
                event.preventDefault();
            }
            lastTouchEnd = now;
        }, false);
    </script>
</body>
                        </html>
